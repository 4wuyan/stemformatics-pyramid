var colours_alternate_sort=["DarkOrchid","Orange","DodgerBlue","Blue","BlueViolet","Brown","Deeppink","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Crimson","Cyan","Red","DarkBlue","DarkGoldenRod","DarkGray","Tomato","Violet","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkRed","DarkSalmon","DarkSlateBlue","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DodgerBlue","FireBrick","ForestGreen","Fuchsia","Gold","GoldenRod","Green","GreenYellow","HotPink","IndianRed","Indigo"];setup_colours_for_group=function(c,b,e,d){var a=0;for(i=0;i<c.length;i++){if(a==e){a=0}b[c[i]]=d[a];a++}return b};default_options=function(){var a={target:"#graph",unique_id:"Sample_ID",margin:{top:80,right:0,bottom:30,left:0},height:1500,width:1060,x_axis_title:"Samples",y_axis_title:"Log2 Expression"};return a};d3_wrap=function(b,a){b.each(function(){var k=d3.select(this),e=k.text().split(/\s+/).reverse(),c,m=[],d=0,h=1.1,f=k.attr("y"),g=k.attr("x"),l=parseFloat(k.attr("dy"));if(isNaN(l)){l=0}tspan=k.text(null).append("tspan").attr("x",g).attr("y",f).attr("dy",l+"em");while(c===e.pop()){m.push(c);tspan.text(m.join(" "));if(tspan.node().getComputedTextLength()>a){m.pop();tspan.text(m.join(" "));m=[c];new_dy=++d*h+l;tspan=k.append("tspan").attr("x",g).attr("y",f).attr("dy",new_dy+"em").text(c).attr("text-anchor","middle")}}})};setup_margins=function(a){options=a.options;page_options.margin=options.margin;page_options.margin_left=options.margin.left;page_options.width=options.width;page_options.margin_top=options.margin.top;page_options.margin_bottom=options.margin.bottom;page_options.height=options.height;page_options.horizontal_grid_lines=options.horizontal_grid_lines;page_options.full_width=options.width+options.margin.left+options.margin.right;page_options.full_height=options.height+options.margin.top+options.margin.bottom;if(a.graph_type=="Box Plot"||a.graph_type=="Line Graph"){width_to_support_many_samples=0;if(options.num_sample_types*options.box_width*2>options.width){width_to_support_many_samples=options.box_width*3}page_options.width_to_support_many_samples=width_to_support_many_samples/2;page_options.width=(width_to_support_many_samples*options.probe_count)+options.width;a.page_options=page_options}if(a.graph_type=="Line Graph"){if(options.num_sample_types*options.box_width*2>options.width){width_to_support_many_samples=options.box_width*3}}if(a.graph_type=="Violin Plot"){if(options.num_sample_types*options.box_width*2>options.width){width_to_support_many_samples=options.box_width*3}}width_to_support_many_samples=0;if(a.graph_type!="Scatter Plot"){if(options.num_sample_types*options.box_width>options.width){options.box_width=(options.width/options.num_sample_types)/4}else{if((options.num_sample_types*options.box_width)/(options.width/options.probe_order.length)>1){options.box_width=(options.width*0.7/options.probe_order.length)/options.num_sample_types}}}page_options.width_to_support_many_samples=width_to_support_many_samples/2;page_options.width=(width_to_support_many_samples*options.probe_count)+options.width;a.page_options=page_options;a.page_options=page_options;return a};set_data_order=function(a){if(options.sample_type_order!=="none"){options.data.sort(function(d,c){return options.sample_type_order.indexOf(d.Sample_Type)-options.sample_type_order.indexOf(c.Sample_Type)})}return a};remove_spaces=function(a){newstring=a.replace(/\s+/g,"_");return newstring};setup_svg=function(h){options=h.options;options.sortByOption=remove_spaces(options.sortByOption);page_options=h.page_options;if(h.graph_type=="Scatter Plot"){full_width=page_options.full_width}else{full_width=page_options.full_width}full_height=page_options.full_height;if(scaling_required=="yes"){var g=0.4;var f=0.4}h.full_width=full_width;h.full_height=full_height;background_stroke_width=options.background_stroke_width;background_stroke_colour=options.background_stroke_colour;if(scaling_required=="yes"){$(options.target).html("").css("width",(full_width*g/1.05)+"px").css("height",(full_height*f)+"px");var d=options.target.id;var a=h.options.tooltip_multiview;options.margin={top:80,left:40,bottom:-100,right:-80};var c=50;var b=d3.select(options.target).append("svg").attr("width",full_width*g/1.05).attr("height",full_height*f).attr("id",d+"-svg").attr("class","graph-svg").on("click",function(){lastClickedGraph=d;open_modal("modalDiv","open")}).append("g").attr("id",d+"-group").attr("transform","translate("+options.margin.left+","+(options.margin.top-c)+") scale("+g+","+f+")")}else{var c=50;$(options.target).html("").css("width",full_width+"px").css("height",full_height+"px");var d=options.target.id;var b=d3.select(options.target).append("svg").attr("width",full_width).attr("height",full_height).attr("id",d+"-svg").attr("class","graph-svg").on("click",function(){if(multiview_graph=="yes"){lastClickedGraph=d;if(scaling_required=="yes"){open_modal("modalDiv","open")}}}).append("g").attr("id",d+"-group").attr("transform","translate("+page_options.margin.left+","+(page_options.margin.top-c)+")")}b.append("rect").attr("width",page_options.width).attr("height",page_options.height).attr("stroke-width",background_stroke_width).attr("stroke",background_stroke_colour).attr("fill",options.background_colour);height_divisor=1.5;count=0;counter=0;main_title_counter=0;main_title_count=0;y_axis_divisor=1.25;var k=options.title.replace(/.{125}\S*\s+/g,"$&@").split(/\s+@/);for(i=0;i<k.length;i++){main_title_counter++;b.append("text").attr("id","main_title").attr("class","graph-title main-title").attr("x",page_options.width/2).attr("y",function(){var l=page_options.margin.top/y_axis_divisor-(parseInt(options.text_size,15)*(i+1));if(l<=0){main_title_count++}return 0-l}).attr("text-anchor","middle").text(k[i]).style("font-family",options.font_style).style("font-size",options.title_text_size).style("fill","black").attr("transform","translate(0,"+(10+(counter*20))+")")}for(i=0;i<options.subtitles.length;i++){var e=(options.subtitles[i].replace(/.{125}\S*\s+/g,"$&@").split(/\s+@/));for(j=0;j<e.length;j++){counter++;b.append("text").attr("id","subtitle").attr("class","graph-title").attr("x",page_options.width/2).attr("y",function(){num=(page_options.margin.top-30)/y_axis_divisor-(parseInt(options.text_size,10)*(i+1));if(num<=0){count++}return 0-num}).attr("text-anchor","middle").text(e[j]).style("font-family",options.font_style).style("font-size",options.title_text_size).style("fill","black").attr("transform","translate(0,"+(10+(counter*20))+")")}}max_width_of_text=800;suggested_width_of_text=options.width*0.7;if(max_width_of_text<suggested_width_of_text){width_of_title=max_width_of_text}else{width_of_title=suggested_width_of_text}b.selectAll("."+options.title_class).call(this.d3_wrap,width_of_title);h.svg=b;return h};setup_watermark=function(a){svg=a.svg;page_options=a.page_options;options=a.options;var c=200;var b=50;options.watermark_width=b;svg.append("image").attr("xlink:href",options.watermark).attr("id","s4m-logo").attr("x",-page_options.height+100).attr("y",page_options.width).attr("transform","rotate(-90)").attr("width",c).attr("height",b);a.svg=svg;return a};setup_horizontal_lines=function(d){svg=d.svg;scaleX=d.scaleX;scaleY=d.scaleY;options=d.options;width=page_options.width;lines=options.lines;horizontal_lines=options.horizontal_lines;font_size=options.text_size;margin_y_value=20;colour_random=d3.scale.category20();var f=undefined;for(var c=0;c<horizontal_lines.length;c++){var b=horizontal_lines[c][0];if(horizontal_lines[c][1]===undefined){var e=colour_random}else{var e=horizontal_lines[c][1]}var a=horizontal_lines[c][2];if(a!="NULL"){svg.append("line").attr("class","lines").attr("data-legend",function(g){return b}).attr("x1",0).attr("x2",width).attr("y1",function(){return scaleY(a)}).attr("y2",scaleY(a)).attr("shape-rendering","crispEdges").attr("stroke-width",options.line_stroke_width).attr("opacity","0.6").style("stroke",e);svg.append("text").attr("x",function(h){var g=margin_y_value+(b.length*3)+15;if(a==f){g=margin_y_value+(b.length*3)+50+prev_size}f=a;prev_size=g;return g}).attr("y",scaleY(a)-5).text(b).attr("text-anchor","middle").style("font-family",options.font_style).style("font-size",font_size).style("fill",e).attr("class",options.title_class)}}d.svg=svg;return d};preprocess_lines=function(a){horizontal_lines=a.options.horizontal_lines;lines=Array();for(key in horizontal_lines){name=key;value=horizontal_lines[key];data_line={value:value,name:name};lines.push(data_line)}a.options.lines=lines;return a};calculate_difference_between_samples=function(a,b){prev_sample_id=a[0];step_sample_id=a[1];value=b(step_sample_id)-b(prev_sample_id);return value};setup_vertical_lines=function(n,b,a){var h=n.svg;vertical_lines=n.outer_label;var e=n.multi_scaleX;var d=0;var k=n.page_options;var m=vertical_lines.length;var l;var g;var c=n.name_mapping;var f=0;h.selectAll(".separator").data(vertical_lines).enter().append("line").attr("class","separator").attr("x1",function(r,p){if(p==0){l="none";d=e(r)/4}if(p==m-1){return 0}var s=c[r.end_name];var o=c[vertical_lines[p+1].start_name];var q=(e(o)-e(s))/2;avg=e(s)+q;return avg}).attr("x2",function(r,p){if(p==0){l="none";d=e(r)/4}if(p==m-1){return 0}var s=c[r.end_name];var o=c[vertical_lines[p+1].start_name];var q=(e(o)-e(s))/2;avg=e(s)+q;return avg}).attr("y1",function(p,o){return 0}).attr("y2",function(p,o){temp=k.height;return temp}).attr("shape-rendering","crispEdges").attr("stroke-width",options.line_stroke_width).attr("opacity","0.2").attr("stroke","black");n.svg=h;return n};make_legend_tooltip=function(){var a=d3.tip().attr("class","d3-tip").offset([0,100]).html(function(e){var b=" Click to view multimapped genes";if(graph_type!="Scatter Plot"){if(sortBy=="Sample_Type"){var c=sample_type_hover[e]}else{var c=e}}else{if(probeInfo_variable[e]["multi_mapping"]=="yes"){var c=e+"<br/>"+b}else{var c=e}}temp=c+"<br/>";return temp});return a};function wrap(d,b,c){var a=1.1;d.each(function(){var n=d3.select(this),h=n.text().split("\n").reverse(),e,p=[],f=0,l=n.attr("y"),m=n.attr("x"),o=parseFloat(n.attr("dy")),k=n.text(null).append("tspan").attr("x",m).attr("y",l-16).attr("dy",0+"em");while(e=h.pop()){p.push(e);k.text(p.join(" "));if((k.node().getComputedTextLength()>b)||((k.node().getComputedTextLength()==0)&&($("#row_3").css("display")=="none"||$("#row_6").css("display")=="none"))){p.pop();var g=k.node().getComputedTextLength()/2;k.text(p.join(" "));p=[e];k=n.append("tspan").attr("x",function(){if(c==".probe_text"&&options.probe_count==1){return m-g/2}else{return m}}).attr("y",l-16).attr("dy",a+f+"em").text(e);f++}}})}regex_function=function(b,a){var c=new RegExp("(.{"+b+"})"+a,"g");return c};setup_D3_legend=function(d,g,t){svg=d.svg;graph_type=d.graph_type;if(typeof(t)=="undefined"){if(graph_type=="Scatter Plot"){t=".exposed_legend"}else{t=".legend"}}probeInfo_variable=d.probeInfo;var n=make_legend_tooltip();svg.call(n);var a=25;var w=" ";var l=1;var h=1;var u=1;var q=g.list;var k=g.name;var f=4;var p=5;var c=12;var o=17;var r=false;var s=20;options=d.options;var e=options.legend_rect_size;page_options=d.page_options;if((d.graph_type=="Box Plot"||d.graph_type=="Violin Graph")&&(options.sortByOption.split(",")[0]=="Sample_Type"||options.sortByOption.split(",")[1]=="Sample_Type")){assigned_colour=options.colour}else{assigned_colour=options.colour_array}legend_counter=0;if(t==".hidden_legend"){var x=0}else{var x=1}var v=115;var m=svg.append("rect").attr("x",page_options.width+(v/2)).attr("y",0).attr("class","legend_border").style("stroke","#000000").style("fill","none").style("stroke-width","1px").style("opacity",0);svg.append("text").attr("x",page_options.width+v).attr("y",s).attr("text-anchor","middle").text(function(){if(t!="none"){return"Legend"}}).attr("class",options.title_class+" legend-title").style("font-family",options.font_style).style("font-size",options.title_text_size).style("fill","#000000");border_counter=1;legend_num=1;var b=svg.selectAll(".legend").data(q).enter().append("g").attr("transform",function(C,A){if(r){border_counter++;r=false}var y=e+17;var B=y/2;var z=-5*e+(page_options.width+(options.legend_padding*border_counter));vertical=(legend_num*y-B+s);legend_num++;if(C.length>(2*a)){h=Math.ceil((C.length/a)/2);legend_num++}else{h=1}if(vertical>400){legend_num=1;r=true}return"translate("+z+","+vertical+")"});id=null;b.append("rect").attr("width",e).attr("class","legendClass").attr("id",function(z,y){return"legend-rect-"+z[y];return"legend-rect-"+z[0]}).attr("height",e).style("fill",function(z,y){return assigned_colour[z]}).style("stroke",function(z,y){return assigned_colour[z]}).style("opacity",1).on("mouseover",n.show).on("mouseout",n.hide);b.append("text").attr("id",function(y){return"legend-text-"+probeInfo_variable[0]}).attr("class","legendClass "+t.replace(".","")).attr("x",e+f).attr("y",e-f).style("font-family",options.font_style).style("font-size",options.text_size).style("opacity",1).text(function(D,B){if(k=="probes"){if(t==".hidden_legend"){if(probeInfo_variable[D]["multi_mapping"]=="yes"){return D+"*"}else{z=options.ref_type;if(z=="probeID"||z=="gene_set_id"){return options.ref_name[D]+" "+D}else{return D}}}else{var z=options.ref_type;legend_counter++;var E=options.probe_name_for_tooltip;var C=probeInfo_variable[D]["label"];if(z=="ensemblID"||z=="miRNA"){var y=options.ref_name[symbol]+" "+C}else{var y=options.ref_name[C]+" "+C}var A=y.replace(regex_function(c,w),"$&\n");if(z=="gene_set_id"||z=="probeID"){if(probeInfo_variable[D]["multi_mapping"]=="yes"){return"Multimapped "+E+" "+legend_counter+"*"}else{return probeInfo_variable[D]["Mapped_gene"]+" "+E+" "+legend_counter}}else{if(probeInfo_variable[D]["multi_mapping"]=="yes"){return"Multimapped "+E+" "+legend_counter+"*"}else{return E+" "+legend_counter}}}}else{var E=D.replace(regex_function(o,w),"$&\n");return E}}).call(wrap,p).style("fill",function(z,y){if(k=="probes"){if(probeInfo_variable[z]["multi_mapping"]=="yes"){return"#ff0000"}else{return"#000000"}}else{return"#000000"}}).on("mouseover",n.show).on("mouseout",n.hide).on("click",function(B){if(k=="probes"){if(probeInfo_variable[B]["multi_mapping"]=="yes"){var z=window.location.href;var y=$("#db_id").html();if(multiview_graph=="yes"){A=$("#last_clicked_ds_id").html()}else{var A=$("#ds_id").html()}new_url=z.split(BASE_PATH)[0]+"//"+z.split(BASE_PATH)[2]+BASE_PATH+"probes/multi_map_summary?general=871&probe_id="+B+"&ds_id="+A+"&db_id="+y;window.location=new_url}}}).style("opacity",x);full_width_var=(full_width+(options.legend_padding*border_counter))+"px";full_width=full_width+(options.legend_padding*border_counter);m.attr("height",500).attr("width",options.legend_padding*border_counter+(options.legend_padding/2));document.getElementsByClassName("graph-svg")[0].setAttribute("width",full_width_var);d.svg=svg;return d};