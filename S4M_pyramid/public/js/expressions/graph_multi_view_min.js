$(document).ready(function(){datasets=$("#multi_view_datasets").html().replace(/\[|]/g,"").replace(/ /g,"").split(",");ref_id=$("#ensemblID").html();ref_type="ensemblID";graphType=$("#graphType").html();db_id=$("#db_id").html();normal_graph_box_width=900;sortBy="Sample_Type";ds_id=0;symbol=$("#symbol").html();show_min_y_axis=false;legend_required="yes";show_axis="no";ref_name={};ref_name[symbol]=symbol;graph_box_width=900;previous_action="";scatter_needed="yes";scaling_required="yes";whiskers_needed=true;full_width=1460;full_height=1000;if(ref_type=="ensemblID"){ref_type_for_title="Gene"}if(graphType==""||graphType==undefined||graphType=="default"){graphType="box"}var b=window.location.href;http_variable=b.split("stemformatics")[0];dataset_data_object={};data_object={};multiview_graph="yes";sample_type_hover={};tooltip_box={};for(var a=0;a<3;a++){if(datasets[a]!=undefined){ajax1(datasets[a])}else{break}}for(var a=3;a<datasets.length;a++){if(datasets[a]!=undefined){ajax1(datasets[a])}else{return}}$("a.chooseGraphType").on("click",function(){graphType=$(this).attr("clickChoose");var e=$(this).attr("data-id");var d;for(var c=0;c<datasets.length;c++){if(data_object[datasets[c]]==null){continue}if(datasets[c]==e){d="no"}else{d="yes"}draw_graph(datasets[c],graph_data_error,dataset_error,d)}});export_graph_data();export_graph_image();click_share_link();click_gene_info();toggleYaxis();multiview_toggle_SD();click_view_genes();multiview_set_autocomplete();contextHelpClick()});function contextHelpClick(){$helpButton=$("a.helpPopup,a.helpbtnPopup,#helpMenu");$helpButton.unbind("click");$helpButton.click(function(a){if(helpsystem.pageHelp.isOn){helpsystem.pageHelp.turnOff();$helpButton.removeClass("active")}else{helpsystem.pageHelp.turnOn();$helpButton.addClass("active")}return false})}function multiview_toggle_SD(){$("#toggleSD").on("click",function(){var a=$(this).attr("data-ds_id");var b="no";if(options.whiskers_needed!=undefined){options.whiskers_needed=!options.whiskers_needed;whiskers_needed=!whiskers_needed}draw_graph(a,graph_data_error,dataset_error,b)})}function multiview_set_autocomplete(){multiview_set_gene_search_and_autocomplete()}function change_gene(a){if(a!=""&&a!=undefined){graph_type=graphType;sort_by=sortBy;if(!window.location.origin){window.location.origin=window.location.protocol+"//"+window.location.host}new_url=window.location.origin+window.location.pathname+"?graphType="+graph_type+"&gene="+a+"&db_id="+db_id;window.location=new_url}}function multiview_set_gene_search_and_autocomplete(){var a=5000;if($("#geneSearchForm").is(":visible")){$("#geneSearch").autocomplete({source:BASE_PATH+"genes/get_autocomplete?db_id="+db_id,minLength:4,timeout:a,appendTo:".searchBox",select:function(b,c){var d=c.item.ensembl_id;change_gene(d)}}).data("ui-autocomplete")._renderItem=function(b,c){return $("<li></li>").append("<a> <div class='symbol'>"+c.symbol+"</div><div class='species'>"+c.species+"</div><div class='aliases'>"+c.aliases+"</div><div class='description'>"+c.description+"</div><div class='clear'></div></a>").appendTo(b)};$("#geneSearch").keypress(function(b){if(b.which==13){b.preventDefault();var c=$("#geneSearch").val();change_gene(c);return false}});$("#geneSearchForm").unbind();$("#geneSearchForm").submit(function(){$("#geneSearch").autocomplete("close");var b=$("#geneSearch").val();change_gene(b);return false})}}function click_view_genes(){$("#viewGenes").unbind();$("#viewGenes").click(function(){$("#geneSearchForm").submit()})}function expand_svg(){var d=1;var l=document.getElementById(lastClickedGraph);var m=ds_id;var c=document.getElementById("modalDiv");var k=150;var h=200;var a=document.getElementById("menu_"+ds_id);var b=full_width;var g=full_height-100;$("#modalDiv").append(a);c.appendChild(l);$("#modalDiv #menu_"+ds_id).css("display","block");$("#modalDiv .legendClass").show();$("#modalDiv .legend-title").show();$("#modalDiv .legend_border").show();$("#modalDiv .x_axis_label").show();$("#modalDiv .y_axis_label").show();$("#modalDiv #main_title").show();$("#modalDiv #s4m-logo").show();$("#modalDiv #subtitle").show();var f=d3.select("#modalDiv #"+lastClickedGraph+"-svg").attr("width",b).attr("height",g);var e=d3.select("#modalDiv #"+lastClickedGraph+"-group").attr("transform","translate("+k+","+h+") scale("+d+","+d+")").on({mouseover:function(n){d3.select(this).style("cursor","default")},mouseout:function(n){d3.select(this).style("cursor","default")}});$("#datasetTitle"+ds_id).css("display","none");contextHelpClick()}function shrink_svg(b){var k=0.4;var a=document.getElementById("menu_"+b);var h=document.getElementById("graphDiv_"+b);var f=document.getElementById("content"+b);var g=full_width*0.45/1.05;var c=full_height*0.35;f.appendChild(a);$("#content"+b).append(h);$("#content"+b+" #menu_"+b).css("display","none");var e=d3.select("#content"+b+" #graphDiv_"+b+"-svg").attr("width",g).attr("height",full_height*0.35);var d=d3.select("#content"+b+" #graphDiv_"+b+"-group").attr("transform","translate(40,80) scale("+k+","+k+")").on({mouseover:function(l){d3.select(this).style("cursor","pointer")},mouseout:function(l){d3.select(this).style("cursor","default")}});scaling_required="yes";$("#content"+b+" .legend-title").hide();$("#content"+b+" .legendClass").hide();$("#content"+b+" .x_axis_label").hide();$("#content"+b+" .y_axis_label").hide();$("#content"+b+" #main_title").hide();$("#content"+b+" #s4m-logo").hide();$("#content"+b+" #subtitle").hide();$("#content"+b+" .legend_border").hide();$("#modalDiv .x_axis_label").show()}function show_rows(a){var c=a.id.split("_")[1];document.getElementById(a.id).style.display="none";var b="row_"+c;document.getElementById(b).style.display="block"}function ajax1(a){return $.ajax({url:http_variable+"stemformatics.org/expressions/dataset_metadata?ds_id="+a,success:function(b){dataset_metadata=JSON.parse(b);dataset_data_object[a]=JSON.parse(dataset_metadata.data);dataset_error=dataset_metadata.error;if(dataset_error==""){dataset_data_object[a]["sampleTypeDisplayGroups"]=JSON.parse(dataset_data_object[a]["sampleTypeDisplayGroups"]);dataset_data_object[a]["ds_id"]=a}if((dataset_data_object[a]["lineGraphOrdering"])&&(dataset_data_object[a]["lineGraphOrdering"]!="NULL")&&(dataset_data_object[a]["lineGraphOrdering"]!="")){dataset_data_object[a]["lineGraphOrdering"]=JSON.parse(dataset_data_object[a]["lineGraphOrdering"])}if((dataset_data_object[a]["detectionThreshold"])==""||isNaN(dataset_data_object[a]["detectionThreshold"])){dataset_data_object[a]["detectionThreshold"]="NULL"}if((dataset_data_object[a]["medianDatasetExpression"])==""||isNaN(dataset_data_object[a]["medianDatasetExpression"])){dataset_data_object[a]["medianDatasetExpression"]="NULL"}graph_data_url=http_variable+"stemformatics.org/expressions/graph_data?db_id="+db_id+"&ds_id="+a+"&ref_id="+ref_id+"&ref_type="+ref_type+"&graph_type="+graphType;var c=document.getElementById("datasetID"+a);$("#dataset"+a).append("<div id='datasetTitle"+a+"' style='display:none;font-size:13px;text-align:center'>"+dataset_data_object[a]["Title"]+"</div>");ajax2(a)}})}function sort_array(c,a){var d=c.toLowerCase();var b=a.toLowerCase();return d>b?1:(d<b?-1:0)}var reA=/[^a-zA-Z]/g;var reN=/[^0-9]/g;function sortAlphaNum_array(e,c){var d=parseInt(e,10);var l=parseInt(c,10);if(isNaN(d)&&isNaN(l)){var h=e.replace(reA,"");var k=c.replace(reA,"");if(h===k){var f=parseInt(e.replace(reN,""),10);var g=parseInt(c.replace(reN,""),10);return f===g?0:f>g?1:-1}else{return h>k?1:-1}}else{if(isNaN(d)){return 1}else{if(isNaN(l)){return -1}else{return d>l?1:-1}}}}function ajax2(a){return $.ajax({url:graph_data_url,success:function(b){graph_data=JSON.parse(b);data_object[a]=JSON.parse(graph_data.data);graph_data_error=graph_data.error;if(graph_data_error==""){unique_probes=[];for(i=0;i<data_object[a].length;i++){if((unique_probes.indexOf(data_object[a][i].Probe)==-1)){unique_probes.push(data_object[a][i].Probe)}}unique_probes_sorted=unique_probes.sort(sort_array);limitSortByArray=dataset_data_object[a]["limitSortBy"].split(",");x_axis_label_object={};for(i=0;i<limitSortByArray.length;i++){groupByOption=limitSortByArray[i];groupByOption_with_underscore=groupByOption.replace(" ","_");x_axis_label_object[groupByOption_with_underscore]=[];for(j=0;j<data_object[a].length;j++){if((x_axis_label_object[groupByOption_with_underscore].indexOf(data_object[a][j][groupByOption_with_underscore])==-1)){x_axis_label_object[groupByOption_with_underscore].push(data_object[a][j][groupByOption_with_underscore])}}}}var c="yes";main_title="Gene Expression Graph for Gene "+symbol+" grouped by Sample Type";draw_graph(a,graph_data_error,dataset_error,c)}})}function changeUrl(a){var b={};$.each(document.location.search.substr(1).split("&"),function(c,d){var e=d.split("=");b[e[0].toString()]=e[1].toString()});b.graphType=a;window.history.pushState({},"","?"+$.param(b))}function draw_graph(e,b,f,c){probe_name=$("#probe_name_"+e).html();data=data_object[e];scaling_required=c;if(graphType=="bar"){show_min_y_axis=false}var h="Sample_Type";var d=document.getElementById("graphDiv_"+e);if(graphType=="scatter"){var g=dataset_data_object[e]["probeColours"]}else{var g=create_array_of_colours_for_legend(dataset_data_object[e]["sampleTypeDisplayGroups"],dataset_data_object[e]["sampleTypeDisplayGroupColours"])}if(b==""&&f==""){if(graphType=="scatter"){$("li.chooseSD").show();changeUrl("scatter");run_scatter_gene_expression_graph(g,d,h,show_min_y_axis,legend_required,ref_name,main_title,whiskers_needed,scaling_required,dataset_data_object[e],probe_name)}else{if(graphType=="box"){var a="no";$("li.chooseSD").hide();changeUrl("box");run_box_bar_gene_expression_graph(g,d,a,h,show_min_y_axis,legend_required,ref_name,main_title,whiskers_needed,scaling_required,dataset_data_object[e],probe_name)}else{if(graphType=="bar"){var a="yes";$("li.chooseSD").show();changeUrl("bar");run_box_bar_gene_expression_graph(g,d,a,h,show_min_y_axis,legend_required,ref_name,main_title,whiskers_needed,scaling_required,dataset_data_object[e],probe_name)}else{if(graphType=="violin"){$("li.chooseSD").hide();changeUrl("violin");run_violin_gene_expression_graph(g,d,h,show_min_y_axis,ref_name,main_title,scaling_required,dataset_data_object[e],probe_name)}}}}}else{$("#graphDiv_"+e).append("<div class='errorTextColumn' style = 'margin-top:12vh;margin-left:2vw;'><div id='errorText' class='title errorBox'><div id='message'>Graph Not Found.</div><div id='prompt'> <span id = 'prompt-message'>The Graph is not available for chosen parameters.</span> </div></div></div>")}if(c=="yes"){shrink_svg(e);$("#content"+e).mouseover(function(){$("#datasetTitle"+e).css("display","block")});$("#content"+e).mouseout(function(){$("#datasetTitle"+e).css("display","none")})}else{expand_svg(e)}}function create_array_of_colours_for_legend(d,c){var a={};var f={};for(var b in d){var e=d[b];if(!(e in a)){a[e]=0}else{a[e]=a[e]+1}f[b]=c[e][a[e]]}return f}function ConvertToTSV(d,e){var h=typeof d!="object"?JSON.parse(d):d;var f="";var g=Object.keys(data_object[e][0]).join(",");g=g.replace(/,/g,"\t");for(var c=0;c<h.length;c++){var a="";for(var b in h[c]){if(a!=""){a+="\t"}a+=h[c][b]}f+=a+"\r\n"}return g+"\n"+f}function export_graph_data(){$(".export_graph_data").on("click",function(){var b=$(this).attr("data-id");var a=ConvertToTSV(data_object[b],b);$("body").append('<form id="exportform" action="'+BASE_PATH+'main/export?format=tsv" method="post" target="_blank"><input type="hidden" id="exportdata" name="exportdata" /></form>');$("#exportdata").val(a);$("#exportform").submit().remove()})}function click_gene_info(){$("a.geneInfoButton").unbind();$("a.geneInfoButton").click(function(){$("#displayGeneDetail").modal({onShow:function(a){$("#simplemodal-container").width("auto")}})})}function toggleYaxis(){$(".no_set_min_y_axis_link").on("click",function(){var b=$(this).attr("data-ds_id");var a="no";show_min_y_axis=!show_min_y_axis;draw_graph(b,graph_data_error,dataset_error,a)})}function export_graph_image(){$("a.exportImageButton").on("click",function(){d3.selectAll(".probe_text").style("opacity",0);d3.selectAll(".hidden-probe_text").style("opacity",1);d3.selectAll(".exposed_legend").style("opacity",0);d3.selectAll(".hidden_legend").style("opacity",1);var a=document.querySelector("svg");var c=new XMLSerializer().serializeToString(a);output_format=$(this).attr("data-type");var b=document.getElementById("svgform");b.output_format.value=output_format;b.file_name.value="Stemformatics_image";b.data.value=c;b.submit();d3.selectAll(".probe_text").style("opacity",1);d3.selectAll(".hidden-probe_text").style("opacity",0);d3.selectAll(".exposed_legend").style("opacity",1);d3.selectAll(".hidden_legend").style("opacity",0)})}function click_share_link(){var a=$("#share_link,a.share_link");a.unbind().click(function(){var d=$(this).attr("data-id");value=check_user_logged_in_for_sharing();if(value==false){return false}var b=$("#gene_set_id");if(b.length==0){gene_set_id=0}else{gene_set_id=b.html()}$("#wb_modal_title").html("Share this graph");var c="<form id='share_link_form'><div id=help_share_link_form>Please note that you can add more than one email address separating each with commas and no spaces. Please be aware that this does not share private objects, such as datasets or gene lists. If the email address you use doesn't have access, they will not be able to view this graph.</div><dl><dt id='to_email_label'>To Email:</dt><dd><input id='to_email_input' class='share_input' type='text' name='to_email' value=''/></dd><dt>Subject:</dt><dd><input class='share_input' type='text' name='subject' value='"+SITE_NAME+" - Expression "+$("div.title").html()+"'/></dd><dt>Body:</dt><dd><textarea class='share_input' name='body' >Here is a link I thought you might want to see:\r\n"+window.location.href+'\r\n\r\nFrom "'+$("#full_name").html()+'" '+$("#user").html()+" via "+SITE_NAME+"</textarea></dd><dt><button id='share_link_form_submit' type='button'>Submit</button></dt><dd></dd></dl><div class='clear'/><input type='hidden' name='ds_id' value="+d+"><input type='hidden' name='gene_set_id' value="+gene_set_id+"></form><div class='clear'/>";$("#wb_modal_content").html(c);$("#modal_div").modal({minHeight:480,onShow:function(e){var f=this;$("#share_link_form_submit").unbind("click");$("#share_link_form_submit").click(function(h){h.preventDefault();$(this).html("Sharing...").addClass("wait");$("#simplemodal-container").addClass("wait");var g=http_variable+"stemformatics.org/auth/share_gene_expression";$.post(g,$("#share_link_form").serialize(),function(k){$("#wb_modal_title").html("Share this graph");$("#wb_modal_content").html(k);$("#simplemodal-container").height("auto").removeClass("wait")})})}})})}function toggle(b){var c=1;var a=document.getElementById(b);if(a.style.display=="none"){a.style.display="block";if(b=="blanket"){return}ds_id=lastClickedGraph.split("_")[1];expand_svg(ds_id)}else{a.style.display="none";if(b=="blanket"){return}shrink_svg(ds_id);$("#modalDiv #graphDiv_"+ds_id).remove();$("#modalDiv #menu_"+ds_id).remove()}}function blanket_size(b){if(typeof window.innerWidth!="undefined"){viewportheight=window.innerHeight/2}else{viewportheight=document.documentElement.clientHeight/2}if((viewportheight>document.body.parentNode.scrollHeight)&&(viewportheight>document.body.parentNode.clientHeight)){blanket_height=viewportheight}else{if(document.body.parentNode.clientHeight>document.body.parentNode.scrollHeight){blanket_height=document.body.parentNode.clientHeight}else{blanket_height=document.body.parentNode.scrollHeight}}var a=document.getElementById("blanket");a.style.height=blanket_height+"px";var c=document.getElementById(b);modalDiv_height=blanket_height/2-400;c.style.top=modalDiv_height/3+"px"}function window_pos(a){if(typeof window.innerWidth!="undefined"){viewportwidth=window.innerHeight}else{viewportwidth=document.documentElement.clientHeight}if((viewportwidth>document.body.parentNode.scrollWidth)&&(viewportwidth>document.body.parentNode.clientWidth)){window_width=viewportwidth}else{if(document.body.parentNode.clientWidth>document.body.parentNode.scrollWidth){window_width=document.body.parentNode.clientWidth}else{window_width=document.body.parentNode.scrollWidth}}var b=document.getElementById(a);window_width=window_width/2-400;b.style.left=window_width+"px"}function open_modal(a,b){if(previous_action==b){return}previous_action=b;blanket_size(a);window_pos(a);toggle("blanket");toggle(a)};