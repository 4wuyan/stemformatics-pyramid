var biojsvisboxplot;module.exports=biojsvisboxplot=function(a){sort_x_by_probe_and_second_sort_by=function(b){options=b.options;if(options.sortByOption.split(",").length!=1){order_types=options.sortByOption.split(",");sample_type_order=options.sample_type_order.split(",");nested_values=d3.nest().key(function(e){return e.Probe}).sortKeys(function(e,d){return probe_order.indexOf(e)-probe_order.indexOf(d)}).key(function(e){value=order_types[0];return e[value]}).key(function(e){return e.Sample_Type}).sortKeys(function(e,d){return sample_type_order.indexOf(e)-sample_type_order.indexOf(d)}).entries(options.data)}else{sample_type_order=options.sample_type_order.split(",");nested_values=d3.nest().key(function(e){return e.Probe}).key(function(e){return e.second_sort_by}).key(function(e){return e.Sample_Type}).sortKeys(function(e,d){return sample_type_order.indexOf(e)-sample_type_order.indexOf(d)}).entries(options.data)}b.nested_values=nested_values;return b};sort_x_by_probe=function(g){options=g.options;if(options.probe_order!="none"){if(options.sortByOption.split(",").length!=1){order_types=options.sortByOption.split(",");var e=options.probe_order;var d=options.sample_type_order.split(",");nested_values=d3.nest().key(function(h){return h.Probe}).sortKeys(function(j,h){return e.indexOf(j)-e.indexOf(h)}).key(function(h){value=order_types[0];return h[value]}).key(function(h){return h.Sample_Type}).sortKeys(function(j,h){return d.indexOf(j)-d.indexOf(h)}).entries(options.data)}else{if(options.sortByOption=="Sample_Type"){var e=options.probe_order;var d=options.sample_type_order.split(",");nested_values=d3.nest().key(function(h){return h.Probe}).sortKeys(function(j,h){return e.indexOf(j)-e.indexOf(h)}).key(function(h){return h.Sample_Type}).sortKeys(function(j,h){return d.indexOf(j)-d.indexOf(h)}).entries(options.data)}else{if(options.sortByOption!="null"){var e=options.probe_order;var b=options.legend_list.list;nested_values=d3.nest().key(function(h){return h.Probe}).sortKeys(function(j,h){return e.indexOf(j)-e.indexOf(h)}).key(function(h){value=options.sortByOption;return h[value]}).sortKeys(function(j,h){return b.indexOf(j)-b.indexOf(h)}).entries(options.data)}}}}else{d=options.sample_type_order.split(",");nested_values=d3.nest().key(function(h){return h.Probe}).key(function(h){return h.Sample_Type}).sortKeys(function(j,h){return d.indexOf(j)-d.indexOf(h)}).entries(options.data)}g.nested_values=nested_values;return g};setup_box_plot=function(g){sample_types_with_colour={};colour_count=0;options=g.options;nested_values=g.nested_values;second_sort_by="";sample_type_list=[];var d=options.colour_array;id=1;for(probe in nested_values){row=nested_values[probe];values=row.values;var e=row.key;if(options.sortByOption.split(",").length!=1){number_sample_types=options.sample_type_order.split(",").length;for(second_sort_bys in values){row=values[second_sort_bys];second_sort_by_values=row.values;second_sort_by=row.key;for(sample_types in second_sort_by_values){sample_row=second_sort_by_values[sample_types];var b=0;sample_values=sample_row.values;sample_type=sample_row.key;if($.inArray(sample_type,sample_type_list)==-1){sample_type_list.push(sample_type)}expression_values=[];for(x in sample_values){if(sample_values[x].Expression_Value==sample_values[x].Expression_Value){expression_values.push(sample_values[x].Expression_Value)}else{b++}}if(expression_values.length!=0){if(options.bar_graph=="yes"){box_plot_vals=calculate_box_plot_vals_bar(expression_values)}else{box_plot_vals=calculate_box_plot_vals(expression_values)}g=draw_box_plot(expression_values,g,box_plot_vals,e,sample_type,second_sort_by,b)}}}}else{number_sample_types=values.length;for(sample_types in values){sample_row=values[sample_types];sample_values=sample_row.values;sample_type=sample_row.key;if($.inArray(sample_type,sample_type_list)==-1){sample_type_list.push(sample_type)}expression_values=[];second_sort_bys=[];second_sort_by_names="";for(x in sample_values){expression_values.push(sample_values[x].Expression_Value);if($.inArray(sample_type,second_sort_bys)==-1){second_sort_bys.push(sample_type)}}for(second_sort_by in second_sort_bys){second_sort_by_names=second_sort_bys[second_sort_by]+" "+second_sort_by_names}var b=0;expression_values=expression_values.filter(function(h){if(h==h){return true}else{b++;return false}});if(expression_values.length!=0){if(options.bar_graph=="yes"){box_plot_vals=calculate_box_plot_vals_bar(expression_values)}else{box_plot_vals=calculate_box_plot_vals(expression_values)}g=draw_box_plot(expression_values,g,box_plot_vals,e,sample_type,second_sort_by_names,b)}}}}g.sample_type_list=sample_type_list;return g};add_scatter_to_box=function(e,h,d,l,g,j,b){options=h.options;radius=options.radius;e.selectAll(".dot").data(d).enter().append("circle").attr("class",function(m){return"sample-type-"+g}).attr("r",radius).attr("cx",l).attr("cy",function(m){var n=scaleY(m);return n}).style("stroke",b).style("stroke-width","1px").style("fill",j).attr("opacity",0.8).on("mouseover",function(){tooltip_box[g].style("left",(d3.event.pageX-50)+"px").style("top",(d3.event.pageY+30)+"px").style("display","inline")}).on("mouseout",function(){tooltip_box[g].style("display","none")}).on("mousemove",function(){tooltip_box[g].style("left",(d3.event.pageX-50)+"px").style("top",(d3.event.pageY+30)+"px").style("display","inline")});return e};make_box_tooltip=function(b,d,h,e){if(options.sortByOption.split(",").length==1){var g=options.sortByOption}else{g=options.sortByOption.split(",")[1]}var j=d3.select("body").append("div").attr("id",b+"_"+d).attr("class","d3-tip").style("display","none").html(function(m){var l=options.probe_name_for_tooltip;temp=l+": "+b+"<br/>";if(e==0){if((sortBy=="Sample_Type")||(sortBy=="Sample Type")||(options.sortByOption.split(",").length!=1)){temp=temp+"Sample Type : "+d+" ["+sample_type_hover[d]+"] <br/>"}else{temp=temp+g+": "+d+"<br/>"}if(options.sortByOption.split(",").length!=1){temp=temp+"State: "+h+"<br/>"}}else{if((sortBy=="Sample_Type")||(sortBy=="Sample Type")||(options.sortByOption.split(",").length!=1)){temp=temp+"Sample Type : "+d+" ["+sample_type_hover[d]+"] <br/>"+e+" Sample Removed Due to Floored Values <br/>"}else{temp=temp+g+": "+d+"<br/>"+e+" Sample Removed Due to Floored Values <br/>"}if(options.sortByOption.split(",").length!=1){temp=temp+"State: "+h+"<br/>"}}return temp});return j};draw_box=function(d,h,m,g,j,l){var e=h.options;var b=h.scaleY;d.append("rect").attr("width",box_width).attr("x",g).attr("id",id).attr("y",function(n){if(e.bar_graph=="yes"){temp=b(Math.max(0,m[1]))}else{temp=b(m[3])}return temp}).attr("height",function(n){if(e.bar_graph=="yes"){temp=Math.abs(b(0)-b(m[1]))}else{temp=b(m[1])-b(m[3])}if(temp==0){temp=2}return temp}).attr("fill",function(){if((e.sortByOption.split(",")[0]=="Sample_Type"||e.sortByOption.split(",")[1]=="Sample_Type")){return e.colour[j]}else{return e.colour_array[j]}}).attr("opacity",opacity).on("mouseover",function(n){l[j].style("left",(d3.event.pageX-50)+"px").style("top",(d3.event.pageY+30)+"px").style("display","inline")}).on("mouseout",function(n){l[j].style("display","none")}).on("mousemove",function(n){l[j].style("left",(d3.event.pageX-50)+"px").style("top",(d3.event.pageY+30)+"px").style("display","inline")});return d};draw_box_plot=function(r,u,s,j,h,q,t){var m=u.svg;scaleY=u.scaleY;scaleX=u.scaleX;options=u.options;tooltip_box={};tooltip_box[h]=make_box_tooltip(j,h,q,t);jitter=options.jitter;box_width=50;var e=u.name_mapping;var v=u.multi_scaleX;var p=options.radius;var n=0.9;if((box_width*options.num_sample_types*options.probe_count)>options.width){box_width=options.width/(options.num_sample_types*options.probe_count)}if(options.sortByOption.split(",").length!=1){for(i=0;i<nested_values[0].values.length;i++){}var g=remove_chars(j+"-"+h+"-"+q);var d=e[g];x_buffer=v(d)-box_width/2}else{var g=remove_chars(j+"-"+h);var d=e[g];x_buffer=v(d)-box_width/2}var b=scale_group_width(u,x_buffer,box_width,v(d-1),v(d+1));var o=m.append("g").attr("id","group-"+g);box_width=box_width*b;box_width_wiskers=options.box_width_wiskers;if(box_width_wiskers*2>box_width){box_width_wiskers=box_width/2}box_width=box_width*b;box_width_wiskers=box_width_wiskers*b;stroke_width=options.stroke_width_num*b;p=p*b;if(p<options.mins.radius){p=options.mins.radius}if(box_width<options.mins.box_width){box_width=options.mins.box_width;box_width_wiskers=options.mins.box_width*0.75}if(stroke_width<options.mins.stroke){stroke_width=options.mins.stroke}stroke_width=stroke_width+"px";if(options.whiskers_needed==true){if((options.sortByOption.split(",")[0]=="Sample_Type"||options.sortByOption.split(",")[1]=="Sample_Type")){colour_wiskers=options.colour[h];colour_box=options.colour[h]}else{colour_wiskers=options.colour_array[h];colour_box=options.colour[h]}}else{colour_wiskers=undefined;colour_box=options.colour[h]}colour_median="white";g=j+"-"+h+"-"+q;if(options.probe_count==1&&options.sortByOption.split(",").length==1&&options.bar_graph=="yes"){opacity=0.4;o=add_vertical_line_to_box(options.stroke_width,x_buffer+box_width*0.5,s[0],s[2],o,scaleY,colour_wiskers,u,tooltip_box,h)}else{if(options.bar_graph=="yes"){opacity=0.4;o=add_vertical_line_to_box(options.stroke_width,x_buffer+box_width*0.5,s[0],s[2],o,scaleY,colour_wiskers,u,tooltip_box,h)}else{opacity=1;o=add_vertical_line_to_box(options.stroke_width,x_buffer+box_width*0.5,s[0],s[4],o,scaleY,colour_wiskers,u,tooltip_box,h)}}var l=options.data[probe*second_sort_by];o=draw_box(o,u,s,x_buffer,h,tooltip_box);if(options.bar_graph=="yes"){if(box_width<8){if(s[0]!=s[2]){o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[0],o,scaleY,colour_wiskers,box_width_wiskers,"no",u,tooltip_box,h);o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[2],o,scaleY,colour_wiskers,box_width_wiskers,"no",u,tooltip_box,h)}}else{o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[0],o,scaleY,colour_wiskers,box_width_wiskers,"yes",u,tooltip_box,h);o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[2],o,scaleY,colour_wiskers,box_width_wiskers,"yes",u,tooltip_box,h)}o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[1],o,scaleY,colour_box,box_width_wiskers,"yes",u,tooltip_box,h);o=add_vertical_line_to_box(options.stroke_width,x_buffer,0,s[1],o,scaleY,colour_box,u,tooltip_box,h);o=add_vertical_line_to_box(options.stroke_width,x_buffer+box_width,0,s[1],o,scaleY,colour_box,u,tooltip_box,h,h)}else{if(box_width<8){o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[0],o,scaleY,colour_wiskers,box_width_wiskers,"no",u,tooltip_box,h);o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[4],o,scaleY,colour_wiskers,box_width_wiskers,"no",u,tooltip_box,h)}else{o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[0],o,scaleY,colour_wiskers,box_width_wiskers,"yes",u,tooltip_box,h);o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[2],o,scaleY,colour_median,(box_width/2)*n,"yes",u,tooltip_box,h);o=add_line_to_box(options.stroke_width,x_buffer,box_width,s[4],o,scaleY,colour_wiskers,box_width_wiskers,"yes",u,tooltip_box,h)}}if(options.test=="yes"){test_values(q+" "+j+"|"+h,s,u,options)}if(options.draw_scatter_on_box=="yes"&&jitter!="yes"){o=add_scatter_to_box(o,u,r,x_buffer+box_width/2,sample_type,"white","black",p)}else{if(options.draw_scatter_on_box=="yes"&&jitter=="yes"){o=draw_jitter_scatter(m,u,r,x_buffer+(box_width/4),box_width,sample_type,"white",colour_wiskers,p)}}u.svg=m;return u};draw_jitter_scatter=function(e,m,h,j,l,n,b,d,g){scaleXBox=d3.scale.ordinal().rangePoints([j,j+l]);options=m.options;scaleXBox.domain(h);scale=(l/2)/h.length;e.selectAll(".dot").data(h).enter().append("circle").attr("class",function(o){return"sample-type-"+n}).attr("r",g).attr("cx",function(p,o){cx=j+(scale*o);return cx}).attr("cy",function(o){var p=scaleY(o);return p}).style("stroke",d).style("stroke-width","1px").style("fill",b).attr("opacity",0.8);return e};test_values=function(d,g,e,b){row=d+","+0+","+0+","+g[0]+","+g[4]+","+g[2]+","+g[1]+","+g[3];if(b.bar_graph=="yes"){row=d+","+g[1]+","+0+","+g[0]+","+g[2]+","+0+","+0+","+0}};get_mean_value=function(b){sum=0;for(i in b){sum+=b[i]}mean=sum/b.length;return mean};calculate_box_plot_vals_bar=function(d){min_max_vals=return_min_max_vals(d);var b=get_mean_value(d);sum=0;numbers_meaned=[];for(x in d){numbers_meaned.push(Math.abs(d[x]-b))}standard_deviation=get_mean_value(numbers_meaned);min=min_max_vals[0];max=min_max_vals[1];return[b-standard_deviation,b,b+standard_deviation]};calculate_box_plot_vals=function(b){b.sort(function(g,e){return g-e});min_max_vals=return_min_max_vals(b);var d=get_median_value(b,0.5);max_quartile=[];min_quartile=[];min_quartile=(b.length%2==0)?b.slice(0,(b.length/2)+1):b.slice(0,Math.floor(b.length/2)+1);max_quartile=(b.length%2==0)?b.slice((b.length/2)-1,b.length):b.slice(Math.ceil(b.length/2)-1,b.length);min_quartile_median=get_median_value(b,0.25);max_quartile_median=get_median_value(b,0.75);min=min_max_vals[0];max=min_max_vals[1];return[min,min_quartile_median,d,max_quartile_median,max]};return_min_max_vals=function(b){max_val=-50;min_val=100;for(sample_value in b){if(b[sample_value]<min_val){min_val=b[sample_value]}if(b[sample_value]>max_val){max_val=b[sample_value]}}return[min_val,max_val]};get_median_value=function(b,d){k=(b.length-1)*d;f=Math.floor(k);c=Math.ceil(k);if(f==c){return b[k]}else{d0=b[f]*(c-k);d1=b[c]*(k-f);return d0+d1}};get_box_plot_values=function(b){options=b.options;expression_values=[];lwr_half_of_Expresssion_vals=[];upr_half_of_expression_vals=[];get_expression_values=d3.extent(options.data,function(e){expression_values.append(e.Expression_Value);return e.Expression_Value});get_expression_values.sort(function(e,d){return e-d});median_val=get_median_value(expression_values);for(val in expression_values){if(val<median_val){lwr_half_of_expresssion_vals.append(val)}else{if(val>median_val){upr_half_of_expression_vals.append(val)}}}third_quartile=get_median_value(lwr_half_of_expresssion_vals);first_quartile=get_median_value(upr_half_of_expression_vals);b.median_val=median_val;b.third_quartile=third_quartile;b.first_quartile=first_quartile;return b};get_type=function(b){return b.probe};setup_graph=function(g){g.graph_type="Box Plot";options=g.options;var d=options.x_axis_label_padding;temp_val=0;diff_val=0;padding_val=0;if(multiview_graph=="no"){tooltip_box={}}var b="bottom";var e=".probe_text";var m=".second_sort";var l=".probe-";var h=".sample_text";var j=".sample-";g=setup_margins(g);g=setup_svg(g);if(options.include_second_sort_by_x_axis=="yes"){g=sort_x_by_probe_and_second_sort_by(g)}else{g=sort_x_by_probe(g)}g=setup_data_for_x_axis(g);g=setup_x_axis(g,g.probe_list);g=setup_x_axis_labels(g,null,d,h,j,3,b);if(options.sortByOption.split(",").length!=1){d+=120;g=setup_x_axis_labels(g,null,d,m,l,2,b);d-=120}d=d-100;g=setup_x_axis_labels(g,null,d,".hidden-probe_text",l,1,b);g=setup_x_axis_labels(g,null,d,e,l,1,b);g=setup_y_axis(g);g=setup_box_plot(g);g=setup_watermark(g);if(options.display.legend==="yes"){g=setup_D3_legend(g,options.legend_list)}if(options.display.vertical_lines=="yes"){g=setup_vertical_lines(g,g.sample_id_list,1);g=setup_vertical_lines(g,g.sample_id_list,2)}if(options.display.horizontal_lines=="yes"){g=setup_horizontal_lines(g)}return g};init=function(b){var d=default_options();d=b;page_options={};var e={};e.options=d;e=preprocess_lines(e);e=setup_graph(e);var g=$(d.target);g.addClass("box_plot");svg=e.svg};init(a)};