remove_chars=function(a){newstring=a.replace(/[&\/\\#,()$~%.'":*?<>{}\s+]/g,"");return newstring};remove_chars_except_space=function(a){newstring=a.replace(/[&\/\\#,()$~%.'":*?<>{}+]/g,"");return newstring};get_x_value=function(f,e){var c=f.multi_scaleX;var d=f.options.sortByOption.split(",");if(options.multi_group!=1){var a=e[d[0]];d[1]="Sample_Type";var b=e[d[1]];var g=f.name_mapping[remove_chars(e.Probe+"-"+b+"-"+a)];centreX=c(g)}else{var g=f.name_mapping[remove_chars(e.Probe+"-"+e[d[0]])];centreX=c(g)}return centreX};create_name_mapping=function(e){var d=[];var b=0;var c=[];for(var f in e){d[e[f]]=b;d.val=b;c.push(b);b++}var a={};a.map=d;a.list=c;return a};setup_data_for_x_axis=function(b){options=b.options;var k=b.nested_values;sort_by_second_sort_bys=false;if(options.multi_group!=1){sort_by_multiple=true}sample_id_list=[];sample_type_list=[];second_sort_by_list=[];var q=[];var n=[];var m=[];second_sort_by_count=0;probe_list=[];line_count=0;var t;var v;var c=[];inner_label=[];outer_label=[];very_inner_label=[];var j;var e;var o;var y;if(multiview_graph=="no"){probeInfo={}}else{if(typeof probeInfo=="undefined"){probeInfo={}}}var d=options.legend_list.list;for(var s in k){second_sort_by_count=0;second_sort_by_list=[];row=k[s];probe=row.key;values=row.values;if(options.multi_group!=1){y={};for(var u in values){var l=values[u];t=l.key;dvals=l.values;tempX={};for(var r in dvals){inner_tempX={};var g=dvals[r];var v=g.key;o=remove_chars(probe+"-"+v+"-"+t);cur_name_with_space=remove_chars_except_space(probe+"-"+v+"-"+t);second_sort_by_list.push(t);second_sort_by_count++;tempX={};tempX.label1=probe;tempX.label2=t;tempX.scale_name=o;inner_tempX.label1=v;inner_tempX.label2=t;inner_tempX.scale_name=o;inner_tempX.end_name=o;inner_tempX.start_name=o;if(b.graph_type!="Scatter Plot"){inner_tempX.hover=sample_type_hover[v];tempX.hover=t}else{tempX.hover=sample_type_hover[t]}if(b.graph_type!="Scatter Plot"){tempX.multi_mapping=k[s].values[0].values[0].values[0]["Multi_Mapping"];tempX.Mapped_gene=k[s].values[0].values[0].values[0]["Mapped_gene"]}if(b.graph_type=="Scatter Plot"){if(multiview_graph=="no"){for(var a in d){if(!probeInfo[d[a]]){for(var x=0;x<k[s].values[0].values[0].values.length;x++){if(d[a]==k[s].values[0].values[0].values[x]["Probe"]){probeInfo[d[a]]=[];probeInfo[d[a]]["label"]=d[a];probeInfo[d[a]]["multi_mapping"]=k[s].values[0].values[0].values[x]["Multi_Mapping"];probeInfo[d[a]]["Mapped_gene"]=k[s].values[0].values[0].values[x]["Mapped_gene"]}}}}}else{var w=k[s].values[0].values[0].values;for(var x=0;x<w.length;x++){if(!probeInfo[w[x]["Probe"]]){probeInfo[w[x]["Probe"]]=[];probeInfo[w[x]["Probe"]]["label"]=w[x]["Probe"];probeInfo[w[x]["Probe"]]["multi_mapping"]=w[x]["Multi_Mapping"];probeInfo[w[x]["Probe"]]["Mapped_gene"]=w[x]["Mapped_gene"]}}}}if(r==0){if(u==0){e=o}j=o;tempX.start_name=o}m.push(tempX);if($.inArray(cur_name_with_space,q)==-1){n.push(cur_name_with_space)}if($.inArray(o,q)==-1){q.push(o)}very_inner_label.push(inner_tempX)}tempX.start_name=j;tempX.end_name=o;inner_label.push(tempX)}e=remove_chars(probe+"-"+values[0].values[0].key+"-"+values[0].key);y.label1=probe;y.label2=t;y.scale_name=o;y.start_name=e;y.end_name=o;if(b.graph_type!="Scatter Plot"){tempX.multi_mapping=k[s].values[0].values[0].values[0]["Multi_Mapping"];tempX.Mapped_gene=k[s].values[0].values[0].values[0]["Mapped_gene"];y.multi_mapping=k[s].values[0].values[0].values[0]["Multi_Mapping"];y.Mapped_gene=k[s].values[0].values[0].values[0]["Mapped_gene"]}y.hover=probe;outer_label.push(y);c.push(e);c.push(o)}else{tempX={};for(var u in values){l=values[u];v=l.key;o=remove_chars(probe+"-"+v);cur_name_with_space=remove_chars_except_space(probe+"-"+v);tempX={};inner_tempX={};tempX.label1=probe;inner_tempX.label1=v;inner_tempX.scale_name=o;tempX.scale_name=o;if(b.graph_type!="Scatter Plot"){if(b.graph_type=="Line Graph"){tempX.multi_mapping=k[s].values[0].values[0].values[0]["Multi_Mapping"];tempX.Mapped_gene=k[s].values[0].values[0].values[0]["Mapped_gene"]}else{tempX.multi_mapping=k[s].values[0].values[0]["Multi_Mapping"];tempX.Mapped_gene=k[s].values[0].values[0]["Mapped_gene"]}tempX.hover=probe;if(sortBy=="Sample_Type"){inner_tempX.hover=sample_type_hover[v]}else{inner_tempX.hover=v}}else{if(sortBy=="Sample_Type"){tempX.hover=sample_type_hover[probe]}else{tempX.hover=probe}}if(b.graph_type=="Scatter Plot"){if(multiview_graph=="no"){for(var a in d){if(!probeInfo[d[a]]){for(var x=0;x<k[s].values[0].values.length;x++){if(d[a]==k[s].values[0].values[x]["Probe"]){probeInfo[d[a]]=[];probeInfo[d[a]]["label"]=d[a];probeInfo[d[a]]["multi_mapping"]=k[s].values[0].values[x]["Multi_Mapping"];probeInfo[d[a]]["Mapped_gene"]=k[s].values[0].values[x]["Mapped_gene"]}}}}}else{var w=k[s].values[0].values;for(var x=0;x<w.length;x++){if(!probeInfo[w[x]["Probe"]]){probeInfo[w[x]["Probe"]]=[];probeInfo[w[x]["Probe"]]["label"]=w[x]["Probe"];probeInfo[w[x]["Probe"]]["multi_mapping"]=w[x]["Multi_Mapping"];probeInfo[w[x]["Probe"]]["Mapped_gene"]=w[x]["Mapped_gene"]}}}}if(u==0){e=o;c.push(e);tempX.start_name=e;inner_tempX.start_name=e}if($.inArray(cur_name_with_space,q)==-1){n.push(cur_name_with_space)}if($.inArray(o,q)==-1){q.push(o)}tempX.start_name=j;tempX.end_name=o;inner_tempX.start_name=o;inner_tempX.end_name=o;inner_label.push(tempX);very_inner_label.push(inner_tempX);m.push(tempX)}tempX.start_name=e;c.push(o);tempX.end_name=o;outer_label.push(tempX)}line_count++}var f=create_name_mapping(q);var h=create_name_mapping(n);b.vertical_lines_mapping=m;b.multi_xaxis_list=n;b.vertical_lines=c;b.name_mapping=f.map;b.name_mapping_with_space=h.map;b.outer_label=outer_label;b.inner_label=inner_label;b.very_inner_label=very_inner_label;b.probeInfo=probeInfo;b.multi_scaleX=setup_multi_axis_scale(b,f.list);b.probe_count=line_count;b.sample_type_list=sample_type_list;b.probe_list=probe_list;b.second_sort_by_list=second_sort_by_list;b.second_sort_by_count=second_sort_by_count;b.sample_id_list=sample_id_list;return b};setup_multi_axis_scale=function(c,b){var a=d3.scale.ordinal().rangePoints([0,c.page_options.width],c.options.padding);a.domain(b);return a};return_y_min_max_values=function(a){options=a.options;max_val=1;min_val=0;lwr_min_max_values_from_data=d3.extent(options.data,function(b){lwr=(b.Expression_Value-b.Standard_Deviation);temp=lwr;if(lwr<min_val){min_val=lwr}if(isNaN(temp)&&isNaN(b.Expression_Value)){temp=0}return temp});upr_min_max_values_from_data=d3.extent(options.data,function(c){var b=1;upr=(c.Standard_Deviation+c.Expression_Value);temp=upr;if(isNaN(c.Expression_Value)&&isNaN(temp)){temp=0}if(upr>max_val){max_val=upr}if(isNaN(temp)&&isNaN(c.Expression_Value)){temp=0}for(i=0;i<options.horizontal_lines.length;i++){if(options.horizontal_lines[i][2]!=="NULL"){if(temp<(options.horizontal_lines[i][2])){temp=Math.ceil(options.horizontal_lines[i][2])+1}}}if((Math.ceil(temp)-temp)<0.2){temp=temp+0.5}return temp});min=lwr_min_max_values_from_data[0];max=upr_min_max_values_from_data[1];if(min>0){if(options.show_min_y_axis==true){min=Math.floor(min)}else{min=0}}if(max<1){Math.round(max*10)/10}for(key in options.horizontal_lines){value=options.horizontal_lines[key];if(value[2]>max){max=Math.ceil(value[2])}if(value[2]<min){min=Math.floor(value[2])}}a.max_val=max_val;a.min_val=min_val;a.force_domain=[min,max];return a};setup_y_axis=function(d){svg=d.svg;max=d.max_val;var b=d3.scale.linear().range([page_options.height,0]);y_column=options.y_column;d=return_y_min_max_values(d);b.domain(d.force_domain).nice();var a=d3.svg.axis().scale(b).orient("left").innerTickSize(-page_options.width).outerTickSize(0);y_axis_legend_y=(d.full_height-options.margin.top-options.margin.bottom)/2;if(scaling_required=="yes"){y_axis_legend_y=(d.full_height-options.margin.top-options.margin.bottom)/4}if(options.display.y_axis_title==="yes"){svg.append("text").text(options.y_axis_title).attr("class","y_axis_label").attr("text-anchor","middle").style("font-family",options.font_style).style("font-size",options.y_label_text_size).attr("transform","rotate(-90)").style("text-anchor","middle").attr("x",-y_axis_legend_y).attr("y",-options.y_label_x_val)}if(options.display.horizontal_grid_lines==="yes"){var c=svg.append("g").attr("class","grid").attr("opacity",options.grid_opacity).attr("stroke",options.grid_colour).attr("stroke-width","0.5").call(a);c.selectAll("text").style({"stroke-width":"0","font-family":"Arial","font-size":"12px"})}else{svg.append("g").call(a)}var e=-5;$(".tick text").attr("transform","translate("+e+",0)");d.svg=svg;d.scaleY=b;d.yAxis=a;return d};setup_x_axis=function(d,c){page_options=d.page_options;svg=d.svg;options=d.options;var a=d3.scale.ordinal().rangePoints([0,page_options.width],options.padding);a.domain(c);var b=d3.svg.axis().scale(a).tickSize(0).orient("bottom");font_size="0px";svg.append("g").attr("class","x_axis").attr("transform","translate(0,"+page_options.height+")").call(b).selectAll("text").attr("dx","-2em").style("font-size",font_size).style("text-anchor","end").attr("dy","-0.1em").attr("transform",function(e){return"rotate(-65)"}).append("text").attr("class","label").attr("x",page_options.width).attr("y",+24).style("text-anchor","end").text(options.x_axis_title);d.svg=svg;d.scaleX=a;return d};calc_x_value_label=function(e,g,a,f){var c=f.prev_line;var b;if(a==0){c="none"}if(options.multi_group!=1){b=g.label1+g.label2}else{b=g.label1}if(b!=c){avg=e.multi_scaleX(e.multi_xaxis_list[a]);c=b;f.prev_line=c;f.xval=avg+e.size_of_half_col;return f}else{f.xval=0;return f}};return_label_name=function(f,a,g,j,b){delimiter=" ";if(g==1){counter_probe++}var h=24;var c;var k=options.ref_type;if(g==1||g==3){temp=f.label1}else{temp=f.label2}if(b==1){if(j.graph_type=="Scatter Plot"||g==3||g==2){c=""}else{if(k=="gene_set_id"||k=="probeID"){c=options.ref_name[temp]}else{c=options.ref_name[symbol]}}word=c+" "+temp;var e=temp;temp=word.replace(regex_function(h,delimiter),"$&\n");if(f.multi_mapping=="yes"){if(k=="gene_set_id"||k=="probeID"){return e+"*"}else{return temp+"*"}}else{return temp}}else{if(b==2){temp=temp.replace(regex_function(h,delimiter),"$&\n");if(f.multi_mapping=="yes"){return temp+"*"}else{return temp}}else{if(b==3){if(j.graph_type=="Scatter Plot"||g==3||g==2){c=temp;counter_probe=""}else{if(k=="gene_set_id"||k=="probeID"){c=options.ref_name[temp]+" "+probe_name}else{c=options.ref_name[symbol]+" "+probe_name}}word=c;temp=word.replace(regex_function(h,delimiter),"$&\n");if(f.multi_mapping=="yes"){if(k=="gene_set_id"){return"Multimapped "+probe_name+"*"}else{return temp+counter_probe+"*"}}else{return temp+" "+counter_probe}}else{if(b==4){if(j.graph_type=="Scatter Plot"||g==3||g==2){c=temp;counter_probe=""}else{c=probe_name}word=c;temp=word.replace(regex_function(h,delimiter),"$&\n");if(f.multi_mapping=="yes"&&g==1){return"Multimapped "+temp+" "+counter_probe+"*"}else{if(g==1){return temp+" "+counter_probe}else{return temp}}}else{if(b==5){if(j.graph_type=="Scatter Plot"||g==3||g==2){c=temp}else{if(k=="probeID"){c=options.ref_name[temp]}else{if(k=="gene_set_id"){c=gene_set_name}else{c=options.ref_name[symbol]}}}word=c;temp=word.replace(regex_function(h,delimiter),"$&\n");if(f.multi_mapping=="yes"){return temp+"*"}else{return temp}}else{if(b==6){if(j.graph_type=="Scatter Plot"||g==3||g==2){c=temp}else{c=probe_name+" "+temp}word=c;temp=word.replace(regex_function(h,delimiter),"$&\n");if(f.multi_mapping=="yes"){return temp+"*"}else{return temp}}}}}}}};setup_x_axis_labels=function(n,c,f,h,e,l){svg=n.svg;counter_probe=0;position=options.axis;var q=options.ref_type;var b=n.name_mapping;if(h==".hidden-probe_text"){var o=0}else{var o=1}page_options=n.page_options;options=n.options;if(l==1){vertical_lines=n.outer_label}else{if(l==3){vertical_lines=n.very_inner_label}else{vertical_lines=n.inner_label}}var m=vertical_lines.length;var a=n.multi_scaleX;var d;var p=5;var k=options.x_axis_text_angle;var g=-45;var j=4;if(q=="probeID"){j=3}else{j=4}svg.selectAll(h).data(vertical_lines).enter().append("text").attr("class","x_axis_diagonal_labels x_axis_label "+h.replace(".","")).style("text-anchor","end").style("fill",function(r){if(r.multi_mapping=="yes"&&l==1){return"#ff0000"}else{return"#000000"}}).attr("id",function(r){}).attr("y",function(){if(position=="top"&&l==1){if(g==-45){y_value=0-f-100}else{y_value=0-f}}else{y_value=page_options.height+f}return y_value}).attr("x",function(u,s){var v=b[u.start_name];var r=b[vertical_lines[s].end_name];var t=(a(r)-a(v))/2;x_value=a(v)+t;return x_value}).text(function(t,r){if(q=="probeID"&&t.multi_mapping=="yes"&&h!=".hidden-probe_text"){j=4;var s=return_label_name(t,r,l,n,j)}else{if(h==".hidden-probe_text"){if(q=="gene_set_id"||q=="probeID"){j=1;var s=return_label_name(t,r,l,n,j)}else{j=2;var s=return_label_name(t,r,l,n,j)}}else{if(q=="gene_set_id"){j=3;var s=return_label_name(t,r,l,n,j)}else{var s=return_label_name(t,r,l,n,j)}}}hover=t.hover;return s}).call(wrap,p,h).style("font-family",options.font_style).style("font-size",options.text_size).on("click",function(v){if(l==1){temp_label=v.label1}else{if(l==3){temp_label=v.label1}else{temp_label=v.label2}}if($("#store_and_submit_select_probes").is(":visible")&&h==".probe_text"){var u="";if($("#textarea-probe").val()){u=$("#textarea-probe").val()+" "}$("#textarea-probe").val("");$("#textarea-probe").val(u+temp_label)}else{if(v.multi_mapping=="yes"){var s=window.location.href;var r=$("#db_id").html();var t=$("#ds_id").html();if(t==undefined){t=$("#last_clicked_ds_id").html()}if(l==1){temp_label=v.label1}else{temp_label=v.label2}new_url=s.split(BASE_PATH)[0]+"//"+s.split(BASE_PATH)[2]+BASE_PATH+"probes/multi_map_summary?axis=934&probe_id="+temp_label+"&ds_id="+t+"&db_id="+r;window.location=new_url}}}).attr("transform",function(v,t){var x=b[v.start_name];var r=b[vertical_lines[t].end_name];var u=(a(r)-a(x))/2;var w=a(x)+u;if(position=="top"&&l==1){var s=0-f;k=g;if(g==-45){s-=100}if(options.probe_count==1&&h!=".hidden-probe_text"){k=0}}else{var s=page_options.height+f}return"rotate("+k+","+w+","+s+")"}).style("text-anchor",function(){if(l==1&&(n.graph_type!="Scatter Plot")){return"start"}else{return"end"}}).style("opacity",o).on("mouseover",function(s){var r=" Click to view multimapped genes";tooltip_label_for_axis=d3.select("body").append("div").attr("id","x-axis-tooltip").attr("class","d3-tip").html(function(){if(q=="gene_set_id"){if(s.multi_mapping=="yes"){return s.hover+" <br/>"+r}else{return s.hover}}else{if(s.multi_mapping=="yes"){return s.hover+" <br/>"+r}else{return s.hover}}}).style("left",(d3.event.pageX-50)+"px").style("top",(d3.event.pageY+30)+"px").style("display","inline");return tooltip_label_for_axis}).on("mouseout",function(r){$("#x-axis-tooltip").remove()}).on("mousemove",function(r){tooltip_label_for_axis.style("left",(d3.event.pageX-50)+"px").style("top",(d3.event.pageY+30)+"px").style("display","inline")});n.svg=svg;return n};setup_x_axis_click_label_button=function(a){var b=50;svg=a.svg;svg.append("text").attr("id","x_axis_button").attr("y",options.height+b).attr("x",(options.width/2)).text("show x axis").on("click",function(){draw_graph_with_axis()});a.svg=svg;return a};label_hover_on_feature=function(c,a,e,b){};label_hover_out_feature=function(g,b,h,e){var a=e.circle_radius;var c=get_type(g);var f=document.getElementsByClassName(h+c);for(i=0;i<f.length;i++){d3.select(f[i]).attr("r",a).style("opacity",1)}};