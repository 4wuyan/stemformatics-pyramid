var ds_id=0;var db_id="";var this_graph_data={};var module={};$(document).ready(function(){ds_id=$("#ds_id").html();dataset_details=$("#dataset_details").html();graph_id="#graph";click_choose_datasets();$("#graph_selection").draggable();$("div.graphControls").draggable();dataset_metadata=jQuery.parseJSON($("#dataset_details").html());var a={lwr:0.4337,upr:0.5169};var c=[200,150,100,50,0];var b=d3.tip().attr("class","d3-tip").offset([-10,+110]).html(function(e){msc_type=e.MSC_Type;total=e.total_subsamplings;msc_call=e.MSC_calls;prediction=round_to_two_decimal_places(e[y_column]);lwr=round_to_two_decimal_places(e.lwr);upr=round_to_two_decimal_places(e.upr);percent=round_to_two_decimal_places(e.percentage);temp="Replicate ID: "+e.Replicate_Group_ID+"<br/>Rohart Score [CI]: "+prediction+" ["+lwr+";"+upr+"]<br/>MSC predicted: "+msc_call+"/"+total+" iterations ("+percent+"%)<br/>";return temp});title="Rohart MSC Test";subtitle1=dataset_metadata[ds_id].title;subtitle2=dataset_metadata[ds_id].cells_samples_assayed;target="#graph";sample_type_hover={};d3.tsv("/msc_signature/get_msc_signature_values?ds_id="+ds_id,function(g,i){i.forEach(function(k){k.lwr=+k.lwr;k.prediction=+k.prediction;k.upr=+k.upr;k.percentage=k.MSC_calls/k.total_subsamplings*100;if(!(k.Sample_Type in sample_type_hover)){sample_type_hover[k.Sample_Type]=k.Sample_Type_Long}});width=i.length*30+200;if(width<1275){width=1275}var f={background_colour:"white",background_stroke_colour:"black",background_stroke_width:"2px",circle_radius:5,data:i,data_columns_for_colour:["MSC_calls","total_subsamplings"],domain_colours:["#FFFFFF","#f99820"],error_bar_width:10,height:1020,horizontal_line_value_column:"value",horizontal_lines:a,legend_class:"legend",legend_range:[0,100],margin:{top:180,right:120,bottom:530,left:200},sample_type_order:dataset_metadata[ds_id].sample_type_order,show_horizontal_line_labels:true,subtitle1:subtitle1,subtitle2:subtitle2,target:target,title:title,title_class:"title",tooltip:b,unique_id:"chip_id",watermark:"http://www.stemformatics.org/img/logo.gif",width:width,x_axis_text_angle:-45,x_axis_title:"Samples",x_column:"Replicate_Group_ID",x_middle_title:477,y_axis_title:"Rohart Score",y_column:"prediction"};var h=biojsvisrohartmsctest(f);var d=["Replicate_Group_ID","Prediction","Lower Bound","Upper Bound","MSC Calls","Total Subsamplings","Percentage %"];var j=["Replicate_Group_ID","prediction","lwr","upr","MSC_calls","total_subsamplings","percentage"];f={title:"Graph data for Rohart MSC Test",column_names:d,data:i,min_height:400,min_width:1000,ds_id:ds_id,click_target_id:"#show_data_table",columns_to_show_in_order:j,div_class:"show_data_table"};var e=data_table(f)});$("div.displayGraphs").removeClass("loading");$("a.export_d3_button").click(function(){this_div="graph";var e=document.getElementById(this_div);var d=e.getElementsByTagName("svg")[0];var g=(new XMLSerializer).serializeToString(d);output_format=$(this).attr("data-type");var f=document.getElementById("svgform");f.output_format.value=output_format;f.file_name.value="rohart_msc_test_"+ds_id;f.data.value=g;f.submit()})});var biojsvisrohartmsctest;module.exports=biojsvisrohartmsctest=function(a){this.default_options=function(){var b={target:"#graph",unique_id:"chip_id",margin:{top:80,right:20,bottom:30,left:40},height:600,width:1060,x_axis_title:"Samples",y_axis_title:"Rohart Score"};return b};this.d3_wrap=function(c,b){c.each(function(){var j=d3.select(this),f=j.text().split(/\s+/).reverse(),d,l=[],e=0,i=1.1,g=j.attr("y"),h=j.attr("x"),k=parseFloat(j.attr("dy"));if(isNaN(k)){k=0}else{k=k}tspan=j.text(null).append("tspan").attr("x",h).attr("y",g).attr("dy",k+"em");while(d=f.pop()){l.push(d);tspan.text(l.join(" "));if(tspan.node().getComputedTextLength()>b){l.pop();tspan.text(l.join(" "));l=[d];new_dy=++e*i+k;tspan=j.append("tspan").attr("x",h).attr("y",g).attr("dy",new_dy+"em").text(d).attr("text-anchor","middle")}}})};this.setup_margins=function(b){options=b.options;page_options.margin=options.margin;page_options.width=options.width-page_options.margin.left-page_options.margin.right;page_options.height=options.height-page_options.margin.top-page_options.margin.bottom;b.page_options=page_options;return b};this.return_y_min_max_values=function(b){options=b.options;lwr_min_max_values_from_data=d3.extent(options.data,function(c){temp=c.lwr;return temp});upr_min_max_values_from_data=d3.extent(options.data,function(c){temp=c.upr;return temp});min=lwr_min_max_values_from_data[0];max=upr_min_max_values_from_data[1];if(min>0){min=0}if(max<1){max=1}for(key in options.horizontal_lines){value=options.horizontal_lines[key];if(value>max){max=value}if(value<min){min=value}}b.force_domain=[min,max];return b};this.setup_y_axis=function(d){padding=30;svg=d.svg;var c=d3.scale.linear().range([page_options.height,0]);var b=d3.svg.axis().scale(c).orient("left");y_column=options.y_column;d=this.return_y_min_max_values(d);c.domain(d.force_domain).nice();y_axis_legend_y=(d.full_height-options.margin.top-options.margin.bottom)/2;svg.append("g").attr("class","y_axis").call(b).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",-60).attr("x",-y_axis_legend_y).attr("dy",".71em").style("text-anchor","middle").text(options.y_axis_title);d.svg=svg;d.scaleY=c;d.yAxis=b;return d};this.setup_data_for_x_axis=function(b){options=b.options;sample_type_order=options.sample_type_order.split(",");nested_values=d3.nest().key(function(c){return c.Sample_Type}).sortKeys(function(d,c){return sample_type_order.indexOf(d)-sample_type_order.indexOf(c)}).entries(options.data);sample_id_list=new Array();vertical_lines=new Array();vert_count=0;count=0;for(temp_count in nested_values){row=nested_values[temp_count];key=row.key;values=row.values;for(count_row in values){sample=values[count_row];sample_id=sample.Replicate_Group_ID;sample_type=sample.Sample_Type;sample_id_list.push(sample_id);count++}temp={};temp.sample_type=key;temp.start_sample_id=values[0].Replicate_Group_ID;temp.end_sample_id=sample_id;vertical_lines.push(temp);vert_count++}b.vertical_lines=vertical_lines;b.sample_id_list=sample_id_list;return b};this.setup_x_axis=function(d){page_options=d.page_options;svg=d.svg;options=d.options;sample_id_list=d.sample_id_list;var b=d3.scale.ordinal().rangeRoundBands([0,page_options.width],0.4);b.domain(sample_id_list);var c=d3.svg.axis().scale(b).orient("bottom");font_size="0px";svg.append("g").attr("class","x_axis").attr("transform","translate(0,"+page_options.height+")").call(c).selectAll("text").attr("dx","-2em").style("font-size",font_size).style("text-anchor","end").attr("dy","-0.1em").attr("transform",function(e){return"rotate(-65)"}).append("text").attr("class","label").attr("x",page_options.width).attr("y",+24).style("text-anchor","end").text(options.x_axis_title);svg.selectAll("g").attr("class","tick").remove();d.nested_values=nested_values;d.sample_id_list=sample_id_list;d.vertical_lines=vertical_lines;d.svg=svg;d.scaleX=b;d=this.setup_x_axis_using_sample_types(d);return d};this.setup_x_axis_using_sample_types=function(b){svg=b.svg;scaleX=b.scaleX;vertical_lines=b.vertical_lines;calculate_x_value_of_sample_types=this.calculate_x_value_of_sample_types;page_options=b.page_options;options=b.options;svg.selectAll(".sample_type_text").data(vertical_lines).enter().append("text").text(function(c){temp=c.sample_type;return temp}).attr("class","x_axis_diagonal_labels").style("text-anchor","end").attr("y",page_options.height+60).attr("x",function(c){avg=calculate_x_value_of_sample_types(c,sample_id_list,scaleX);return avg}).attr("transform",function(e,c){x_value=calculate_x_value_of_sample_types(e,sample_id_list,scaleX);y_value=page_options.height+60;return"rotate("+options.x_axis_text_angle+","+x_value+","+y_value+")"}).on("mouseover",function(c){var e=d3.select("body").append("div").attr("id","x-axis-tooltip").attr("class","d3-tip").text(c.sample_type).style("left",(d3.event.pageX-50)+"px").style("top",(d3.event.pageY-50)+"px").style("display","inline").style("opacity","1");return e}).on("mouseout",function(c){$("#x-axis-tooltip").remove()});b.svg=svg;return b};this.calculate_x_value_of_sample_types=function(h,c,e){var b=e(h.start_sample_id);var g=e(h.end_sample_id);var f=(b+g)/2;return f};this.calculate_x_value_of_vertical_lines=function(h,b,e){this_sample_index=b.indexOf(h.end_sample_id);next_sample_id=b[this_sample_index+1];var c=e(h.end_sample_id);var g=e(next_sample_id);if(g!=undefined){var f=(c+g)/2}else{var f=0}return f};this.setup_vertical_lines=function(b){svg=b.svg;vertical_lines=b.vertical_lines;sample_id_list=b.sample_id_list;page_options=b.page_options;calculate_x_value_of_vertical_lines=this.calculate_x_value_of_vertical_lines;svg.selectAll(".separator").data(vertical_lines).enter().append("line").attr("class","separator").attr("x1",function(c){avg=calculate_x_value_of_vertical_lines(c,sample_id_list,scaleX);return avg}).attr("x2",function(c){avg=calculate_x_value_of_vertical_lines(c,sample_id_list,scaleX);return avg}).attr("y1",function(c){temp=0;return temp}).attr("y2",function(c){temp=page_options.height;return temp}).attr("shape-rendering","crispEdges").attr("stroke-width","1px").attr("opacity","0.2").attr("stroke","black");b.svg=svg;return b};this.setup_error_bars=function(b){svg=b.svg;options=b.options;page_options=b.page_options;scaleX=b.scaleX;scaleY=b.scaleY;tooltip=b.options.tooltip;shape_rendering="auto";stroke_width="2px";width=options.error_bar_width;svg.selectAll(".max").data(options.data).enter().append("line").attr("class","max").attr("x1",function(e){var c=scaleX(e[options.x_column])-width;return c}).attr("x2",function(e){var c=scaleX(e[options.x_column])+width;return c}).attr("y1",function(c){temp=scaleY(c.upr);return temp}).attr("y2",function(c){temp=scaleY(c.upr);return temp}).attr("shape-rendering",shape_rendering).attr("stroke-width",stroke_width).attr("stroke","black").on("mouseover",tooltip.show).on("mouseout",tooltip.hide).style("fill","none");svg.selectAll(".min").data(options.data).enter().append("line").attr("class","min").attr("x1",function(e){var c=scaleX(e[options.x_column])-width;return c}).attr("x2",function(e){var c=scaleX(e[options.x_column])+width;return c}).attr("y1",function(c){temp=scaleY(c.lwr);return temp}).attr("y2",function(c){temp=scaleY(c.lwr);return temp}).attr("shape-rendering",shape_rendering).attr("stroke-width",stroke_width).attr("stroke","black").on("mouseover",tooltip.show).on("mouseout",tooltip.hide).style("fill","none");svg.selectAll(".vertical").data(options.data).enter().append("line").attr("class","vertical").attr("x1",function(e){var c=scaleX(e[options.x_column]);return c}).attr("x2",function(e){var c=scaleX(e[options.x_column]);return c}).attr("y1",function(c){temp=scaleY(c.upr);return temp}).attr("y2",function(c){temp=scaleY(c.lwr);return temp}).attr("shape-rendering",shape_rendering).attr("stroke-width",stroke_width).on("mouseover",tooltip.show).on("mouseout",tooltip.hide).attr("stroke-width","2px").attr("stroke","black").style("fill","none");b.svg=svg;return b};this.setup_scatter=function(c){svg=c.svg;options=c.options;page_options=c.page_options;scaleX=c.scaleX;scaleY=c.scaleY;y_column=options.y_column;x_column=options.x_column;tooltip=options.tooltip;svg.call(tooltip);var b=d3.scale.linear().domain(options.legend_range).range(options.domain_colours);svg.selectAll(".dot").data(options.data).enter().append("circle").attr("class","dot").attr("r",options.circle_radius).attr("cx",function(f){var e=scaleX(f[options.x_column]);return e}).attr("cy",function(e){var f=scaleY(e[options.y_column]);return f}).style("stroke","black").style("stroke-width","1px").style("fill",function(e){number=e[options.data_columns_for_colour[0]];total=e[options.data_columns_for_colour[1]];temp=number/total*100;color=b(temp);return color}).on("mouseover",tooltip.show).on("mouseout",tooltip.hide);c.heat_map_colour=b;c.svg=svg;return c};this.setup_legend=function(d){svg=d.svg;options=d.options;page_options=d.page_options;heat_map_colour=d.heat_map_colour;var c=130;height=30;margin_x=-45;margin_y=7;title_x=110;title_y=-20;base_x=-110;base_y=-options.margin.top/2;zero_axis_move=50;text_width=100;legend_title="% called MSC";var b=svg.append("svg:defs").append("svg:linearGradient").attr("id","gradient").attr("x1","100%").attr("y1","0%").attr("x2","0%").attr("y2","0%").attr("spreadMethod","pad");b.append("svg:stop").attr("offset","0%").attr("stop-color",options.domain_colours[0]).attr("stop-opacity",1);b.append("svg:stop").attr("offset","100%").attr("stop-color",options.domain_colours[1]).attr("stop-opacity",1);svg.append("svg:rect").attr("x",base_x).attr("y",base_y).attr("width",c).attr("height",height).style("stroke-width","1px").style("stroke","black").style("fill","url(#gradient)");svg.append("text").attr("x",base_x+title_x).attr("y",base_y+title_y).attr("transform","translate("+margin_x+","+margin_y+")").attr("width",text_width).attr("text-anchor","middle").text(legend_title).attr("class","legend_text");svg.append("text").attr("x",base_x).attr("y",base_y).attr("y",base_y).attr("transform","translate("+margin_x+","+margin_y+")").attr("text-anchor","right").text(options.legend_range[1]+"%").attr("class","legend_text");svg.append("text").attr("x",base_x+c+zero_axis_move).attr("y",base_y).attr("width",text_width).attr("text-anchor","right").attr("transform","translate("+margin_x+","+margin_y+")").text(options.legend_range[0]+"%").attr("class","legend_text");return d};this.setup_horizontal_lines=function(b){svg=b.svg;options=b.options;width=page_options.width;lines=options.lines;show_horizontal_line_labels=options.show_horizontal_line_labels;scaleY=b.scaleY;y1=y2=scaleY(0.4);svg.selectAll(".lines").data(lines).enter().append("line").attr("class","lines").attr("x1",0).attr("x2",width).attr("y1",function(c){temp=scaleY(c[options.horizontal_line_value_column]);return temp}).attr("y2",function(c){temp=scaleY(c[options.horizontal_line_value_column]);return temp}).attr("shape-rendering","crispEdges").attr("stroke-width","1px").attr("stroke","black").style("fill","none");b.svg=svg;return b};this.preprocess_lines=function(b){horizontal_lines=b.options.horizontal_lines;lines=Array();for(key in horizontal_lines){name=key;value=horizontal_lines[key];data_line={value:value,name:name};lines.push(data_line)}b.options.lines=lines;return b};this.setup_svg=function(c){options=c.options;page_options=c.page_options;full_width=options.width;full_height=options.height;c.full_width=full_width;c.full_height=full_height;background_stroke_width=options.background_stroke_width;background_stroke_colour=options.background_stroke_colour;$(options.target).html("").css("width",full_width+"px").css("height",full_height+"px");var b=d3.select(options.target).append("svg").attr("width",full_width).attr("height",full_height).append("g").attr("transform","translate("+page_options.margin.left+","+page_options.margin.top+")");b.append("rect").attr("width",page_options.width).attr("height",page_options.height).attr("stroke-width",background_stroke_width).attr("stroke",background_stroke_colour).attr("fill",options.background_colour);height_margin=20;height_divisor=1.5;b.append("text").attr("x",options.x_middle_title).attr("y",0-(page_options.margin.top/height_divisor)-(height_margin*2)).attr("text-anchor","middle").text(options.title).attr("class",options.title_class);b.append("text").attr("x",options.x_middle_title).attr("y",0-(page_options.margin.top/height_divisor)).attr("text-anchor","middle").text(options.subtitle1).attr("class",options.title_class+" subtitle1");b.append("text").attr("x",options.x_middle_title).attr("y",0-(page_options.margin.top/height_divisor)+height_margin*3).attr("text-anchor","middle").text(options.subtitle2).attr("class",options.title_class+" subtitle2");max_width_of_text=800;suggested_width_of_text=options.width*0.7;if(max_width_of_text<suggested_width_of_text){width_of_title=max_width_of_text}else{width_of_title=suggested_width_of_text}b.selectAll("."+options.title_class).call(this.d3_wrap,width_of_title);c.svg=b;return c};this.setup_rohart_background_text=function(b){options=b.options;page_options=b.page_options;svg=b.svg;scaleY=b.scaleY;font_size="20px";margin_y_value_msc=20;svg.append("text").attr("x",(page_options.width/2)).attr("y",scaleY(options.horizontal_lines.upr)-margin_y_value_msc).text("MSC").attr("text-anchor","middle").style("font-family","Arial").style("font-size",font_size).style("fill","grey").attr("class",options.title_class);svg.append("text").attr("x",(page_options.width/2)).attr("y",scaleY(options.horizontal_lines.lwr)+margin_y_value_msc).text("Non-MSC").attr("text-anchor","middle").style("font-family","Arial").style("font-size",font_size).style("fill","grey").attr("class",options.title_class);b.svg=svg;return b};this.setup_watermark=function(b){svg=b.svg;options=b.options;svg.append("image").attr("xlink:href",options.watermark).attr("x",70).attr("y",-(b.full_width-options.margin.left)).attr("transform","rotate(+90)").attr("width",200).attr("height",100);b.svg=svg;return b};this.setup_graph=function(b){b=this.setup_margins(b);b=this.setup_svg(b);b=this.setup_data_for_x_axis(b);b=this.setup_x_axis(b);b=this.setup_y_axis(b);b=this.setup_error_bars(b);b=this.setup_scatter(b);b=this.setup_horizontal_lines(b);b=this.setup_watermark(b);b=this.setup_vertical_lines(b);return b};this.init=function(b){var c=this.default_options();c=b;page_options={};var d={};d.options=c;d=this.preprocess_lines(d);d=this.setup_graph(d);d=this.setup_legend(d);var e=$(c.target);e.addClass("rohart_msc_graph")};this.init(a)};