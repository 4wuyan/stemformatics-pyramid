function changeUrl(e,d){d=encodeURI(d);e=encodeURI(e);var b=document.location.search.substr(1).split("&");var c=b.length;var a;while(c--){a=b[c].split("=");if(a[0]==d){a[1]=e;b[c]=a.join("=");break}}if(c<0){b[b.length]=[d,e].join("=")}window.history.pushState({},"","?"+b.join("&"))}var reA=/[^a-zA-Z]/g;var reN=/[^0-9]/g;function sort_object(d,c){return d.Mapped_gene===c.Mapped_gene?0:d.Mapped_gene>c.Mapped_gene?1:-1}function sortAlphaNum_array(e,c){var d=parseInt(e,10);var l=parseInt(c,10);if(isNaN(d)&&isNaN(l)){var h=e.replace(reA,"");var k=c.replace(reA,"");if(h===k){var f=parseInt(e.replace(reN,""),10);var g=parseInt(c.replace(reN,""),10);return f===g?0:f>g?1:-1}else{return h>k?1:-1}}else{if(isNaN(d)){return 1}else{if(isNaN(l)){return -1}else{return d>l?1:-1}}}}function sort_array(c,a){var d=c.toLowerCase();var b=a.toLowerCase();return d>b?1:(d<b?-1:0)}function sortSampleId(d,c){return d.Replicate_ID>c.Replicate_ID?1:-1}function sort_array_of_objects(d,c){var f=d.key.toLowerCase();var e=c.key.toLowerCase();return((f<e)?-1:((f>e)?1:0))}function create_array_of_colours_for_legend(e,d,a){var b={};var g={};for(var c=0;c<a.length;c++){var f=e[a[c]];if(!(f in b)){b[f]=0}else{b[f]=b[f]+1}g[a[c]]=d[f][b[f]]}return g}function add_limit_sort_by_options_to_dropdown(){if(dataset_data.limitSortBy!="SampleType"){tempList=dataset_data.limitSortBy.split(",");for(i=0;i<tempList.length;i++){$("#graphOptionsMenu ul").append(" <li><a href='#'' class=chooseSortType clickChoose='"+tempList[i]+"'>Group By "+tempList[i]+"</a></li>");if(tempList[i]!="Sample Type"){$("#graphOptionsMenu ul").append(" <li><a href='#'' class=chooseSortType clickChoose='"+tempList[i]+",Sample Type'>Group By Sample type and "+tempList[i]+"</a></li>")}}}}function multi_map_probe_click(){var a=a;for(var b=0;b<a.probe_order;b++){$("#xLabel-"+a.probe_order[b]).on("click",function(){})}}function draw_graph_with_axis(){$("#x_axis_button").css("display","none");show_axis="yes";graph_box_width=expanded_graph_box_width;toggle_counter=1;draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)}function draw_graph(a,o,c,m,l,g,h,e,f,k,n){h=return_title(ref_type_for_title,symbol,m);if(c=="bar"){l=false}if(c=="line"){m="Sample_Type"}if(c=="box"||c=="bar"||c=="violin"){var b=Object.keys(k.sampleTypeDisplayGroups).sort(function(q,p){return k.sampleTypeDisplayGroups[q]-k.sampleTypeDisplayGroups[p]});var d=create_array_of_colours_for_legend(k.sampleTypeDisplayGroups,k.sampleTypeDisplayGroupColours,b)}else{var d=k.probeColours}$("a.chooseSortType").show();if(a==""&&o==""){if(c=="scatter"){$("li.toggle_select_probes").hide();$("li.chooseSD").show();document.getElementById("showScatterDiv").style.display="none";changeUrl("scatter","graphType");run_scatter_gene_expression_graph(d,graphDiv,m,l,legend_required,g,h,e,f,k,probe_name,ref_type)}else{if(c=="box"){$("li.toggle_select_probes").show();$("li.chooseSD").hide();document.getElementById("showScatterDiv").style.display="block";changeUrl("box","graphType");run_box_bar_gene_expression_graph(d,graphDiv,"no",m,l,legend_required,g,h,e,f,k,probe_name,ref_type)}else{if(c=="bar"){$("li.toggle_select_probes").show();$("li.chooseSD").show();document.getElementById("showScatterDiv").style.display="block";changeUrl("bar","graphType");run_box_bar_gene_expression_graph(d,graphDiv,"yes",m,l,legend_required,g,h,e,f,k,probe_name,ref_type)}else{if(c=="line"){$("a.chooseSortType").hide();$("li.toggle_select_probes").show();$("li.chooseSD").hide();document.getElementById("showScatterDiv").style.display="none";changeUrl("line","graphType");run_line_gene_expression_graph(d,graphDiv,m,l,g,h,f,k,probe_name,ref_type)}else{if(c=="violin"){$("li.toggle_select_probes").show();$("li.chooseSD").hide();document.getElementById("showScatterDiv").style.display="none";changeUrl("violin","graphType");run_violin_gene_expression_graph(d,graphDiv,m,l,g,h,f,k,probe_name,ref_type)}}}}}}else{$("#graphDiv").append("<div class='errorTextColumn'><div id='errorText' class='title errorBox'><div id='message'>Graph Not Found.</div><div id='prompt'> <span id = 'prompt-message'>The Graph is not available for chosen parameters.</span> <br><br> Please Try Following: <br><br> Change Dataset using 'Change Datasets' button provided above <br><br> Change "+ref_type_for_title+" name using the search box provided above <br><br>If you typed the page address in the Address bar, check the spelling and use of upper-case and lower-case letters. </div></div></div>");disable_buttons()}}function disable_buttons(){$(".buttonMenus > li> a").on("click",function(a){a.preventDefault();return false});$(".geneInfoButton").addClass("disabled")}function toggle_SD(){$("#toggleSD").unbind();$("#toggleSD").on("click",function(){if(options.whiskers_needed!=undefined){options.whiskers_needed=!options.whiskers_needed;whiskers_needed=!whiskers_needed}draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,options.whiskers_needed,scaling_required,dataset_data,show_axis)})}function ConvertToTSV(d){var g=typeof d!="object"?JSON.parse(d):d;var e="";var f=Object.keys(data[0]).join(",");f=f.replace(/,/g,"\t");for(var c=0;c<g.length;c++){var a="";for(var b in g[c]){if(a!=""){a+="\t"}a+=g[c][b]}e+=a+"\r\n"}return f+"\n"+e}function toggleYaxis(){$("#no_set_min_y_axis_link").on("click",function(){show_min_y_axis=!show_min_y_axis;draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)})}toggle_counter=0;function toggleHorizontal(){$("#zoomHorizontalGraphButton").on("click",function(){if((unique_probes_sorted.length*dataset_data.sampleTypeDisplayOrder.split(",").length*40)>graph_box_width||(ref_type=="gene_set_id")){if(toggle_counter==0){graph_box_width=expanded_graph_box_width;toggle_counter++;show_axis="yes";draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)}else{toggle_counter--;graph_box_width=normal_graph_box_width;show_axis="no";draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)}}else{if(graph_box_width>normal_graph_box_width){if(toggle_counter==1){toggle_counter--}graph_box_width=normal_graph_box_width;draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)}}})}function click_share_link(){var a=$("#share_link,a.share_link");a.unbind().click(function(){value=check_user_logged_in_for_sharing();if(value==false){return false}var b=$("#gene_set_id");if(b.length==0){gene_set_id=0}else{gene_set_id=b.html()}$("#wb_modal_title").html("Share this graph");var c="<form id='share_link_form'><div id=help_share_link_form>Please note that you can add more than one email address separating each with commas and no spaces. Please be aware that this does not share private objects, such as datasets or gene lists. If the email address you use doesn't have access, they will not be able to view this graph.</div><dl><dt id='to_email_label'>To Email:</dt><dd><input id='to_email_input' class='share_input' type='text' name='to_email' value=''/></dd><dt>Subject:</dt><dd><input class='share_input' type='text' name='subject' value='"+SITE_NAME+" - Expression "+$("div.title").html()+"'/></dd><dt>Body:</dt><dd><textarea class='share_input' name='body' >Here is a link I thought you might want to see:\r\n"+window.location.href+'\r\n\r\nFrom "'+$("#full_name").html()+'" '+$("#user").html()+" via "+SITE_NAME+"</textarea></dd><dt><button id='share_link_form_submit' type='button'>Submit</button></dt><dd></dd></dl><div class='clear'/><input type='hidden' name='ds_id' value="+ds_id+"><input type='hidden' name='gene_set_id' value="+gene_set_id+"></form><div class='clear'/>";$("#wb_modal_content").html(c);$("#modal_div").modal({minHeight:480,onShow:function(d){var e=this;$("#share_link_form_submit").unbind("click");$("#share_link_form_submit").click(function(g){g.preventDefault();$(this).html("Sharing...").addClass("wait");$("#simplemodal-container").addClass("wait");var f=http_variable+"stemformatics.org/auth/share_gene_expression";$.post(f,$("#share_link_form").serialize(),function(h){$("#wb_modal_title").html("Share this graph");$("#wb_modal_content").html(h);$("#simplemodal-container").height("auto").removeClass("wait")})})}})})}function export_graph_image(){$("a.exportImageButton").on("click",function(){d3.selectAll(".probe_text").style("opacity",0);d3.selectAll(".hidden-probe_text").style("opacity",1);d3.selectAll(".exposed_legend").style("opacity",0);d3.selectAll(".hidden_legend").style("opacity",1);var a=document.querySelector("svg");var c=new XMLSerializer().serializeToString(a);output_format=$(this).attr("data-type");var b=document.getElementById("svgform");b.output_format.value=output_format;b.file_name.value="Stemformatics_image";b.data.value=c;b.submit();d3.selectAll(".probe_text").style("opacity",1);d3.selectAll(".hidden-probe_text").style("opacity",0);d3.selectAll(".exposed_legend").style("opacity",1);d3.selectAll(".hidden_legend").style("opacity",0)})}function export_graph_data(){$(".export_graph_data").on("click",function(){var a=ConvertToTSV(data);$("body").append('<form id="exportform" action="'+BASE_PATH+'main/export?format=tsv" method="post" target="_blank"><input type="hidden" id="exportdata" name="exportdata" /></form>');$("#exportdata").val(a);$("#exportform").submit().remove()})}function click_gene_info(){$("a.geneInfoButton").unbind();$("a.geneInfoButton").click(function(){$("#displayGeneDetail").modal({onShow:function(a){$("#simplemodal-container").width("auto")}})})}function choose_dataset_filter(){choose_dataset=$("#choose_dataset").dataTable({bPaginate:false,bLengthChange:false,bFilter:true,bSort:true,bInfo:false,aaSorting:[[0,"asc"]],aoColumns:[null],bAutoWidth:false,oLanguage:{sSearch:"Filter: "}})}function show_all_datasets(){$(".multi_select").modal({minWidth:800,maxHeight:500})}function set_gene_search_and_autocomplete(){if($("#geneSearchForm").is(":visible")){$("#geneSearch").autocomplete({source:BASE_PATH+"genes/get_autocomplete?db_id="+db_id,minLength:4,timeout:AUTOCOMPLETE_TIMEOUT,appendTo:".searchBox",select:function(a,b){var c=b.item.ensembl_id;change_gene(c)}}).data("ui-autocomplete")._renderItem=function(a,b){return $("<li></li>").append("<a> <div class='symbol'>"+b.symbol+"</div><div class='species'>"+b.species+"</div><div class='aliases'>"+b.aliases+"</div><div class='description'>"+b.description+"</div><div class='clear'></div></a>").appendTo(a)};$("#geneSearch").keypress(function(a){if(a.which==13){a.preventDefault();var b=$("#geneSearch").val();change_gene(b);return false}});$("#viewGenes,#geneSearchSubmit").click(function(){var a=$("#geneSearch").val();change_gene(a);return false});$("#geneSearchForm").submit(function(a){a.preventDefault();var b=$("#geneSearch").val();change_gene(b);return false})}}function set_feature_search_and_autocomplete(){var a="default";var b=new Object();b.id="#featureSearch";b.data_url=BASE_PATH+"genes/get_feature_search_autocomplete?feature_type=all&db_id="+db_id;b.target_url=BASE_PATH+"expressions/feature_result?graphType="+graphType+"&datasetID="+ds_id+"&feature_type=miRNA&db_id="+db_id+"&feature_id=";b.append_to=".searchBox";setup_feature_search_autocomplete(b);$("#viewGenes,#featureSearchSubmit").click(function(){chosen_feature_action();return false});$("#featureSearchForm").submit(function(c){c.preventDefault();chosen_feature_action();return false})}function chosen_feature_action(){var a="default";var b=$("#featureSearch").val().replace("+","%2B");window.location=BASE_PATH+"expressions/feature_result?graphType="+a+"&datasetID="+ds_id+"&feature_type=miRNA&feature_id="+encodeURIComponent(b)+"&db_id="+db_id}function set_probe_search_and_autocomplete(){$("#probeSearch").autocomplete({source:BASE_PATH+"datasets/autocomplete_probes_for_dataset?ds_id="+ds_id,minLength:2,timeout:AUTOCOMPLETE_TIMEOUT,appendTo:".searchBox",select:function(b,c){var a=c.item.value;chosen_probe_action(a)}});$("#viewProbes,#probeSearchSubmit").click(function(){var a=$("#probeSearch").val();chosen_probe_action(a);return false});$("#probeSearchForm").submit(function(b){b.preventDefault();var a=$("#probeSearch").val();chosen_probe_action(a);return false})}function chosen_probe_action(a){window.location=BASE_PATH+"expressions/probe_result?graphType="+graphType+"&datasetID="+ds_id+"&probe="+encodeURIComponent(a)+"&db_id="+db_id}function change_gene(a){if(a!=""&&a!=undefined){if(!window.location.origin){window.location.origin=window.location.protocol+"//"+window.location.host}new_url=window.location.origin+window.location.pathname+"?graphType="+graphType+"&datasetID="+ds_id+"&gene="+a+"&db_id="+db_id;window.location=new_url}}function click_choose_datasets(){$("#chooseDatasets").unbind();$("#chooseDatasets").click(function(a){if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}show_all_datasets();choose_dataset_filter()})}function click_select_probes(){$("#toggle_select_probes").unbind();$("#toggle_select_probes").on("click",function(){if(click_to_select_probes==false){click_to_select_probes=true;probe_name_element=$("#probe_name");if(probe_name_element.length){probe_n=probe_name_element.html()}else{probe_n="Probe"}new_html='<div id="store_and_submit_select_probes" class="select_probes"><div class="title">Select '+probe_n+'s</div><div class="help">Click on the '+probe_n+'s under the graph to select and then submit to view them</div><textarea id="textarea-probe"></textarea><input type="submit"></submit></div>';$("body").append(new_html);$("div.select_probes").draggable();$("div.select_probes input").click(function(){var b=new URL(document.URL);var a=$("div.select_probes textarea").val();b.get_data.select_probes=encodeURIComponent(a);new_url=b.get_url();window.location=new_url})}else{if(click_to_select_probes==true){click_to_select_probes=false;$("div.select_probes input").unbind();$("div.select_probes").draggable("disable");$("#store_and_submit_select_probes").remove()}}})}function return_title(c,d,b){var b=b.split("_").join(" ");var e="Gene";if(ref_type=="probeID"){if(d.match(/\s/g)){d="Selected"}else{d=symbol}e=""}else{if(ref_type=="gene_set_id"){d="";e=""}}if(graphType=="line"){var a=e+" Expression Graph for "+c+" "+d+" grouped by line groups"}else{var a=e+" Expression Graph for "+c+" "+d+" grouped by "+b}return a}function spawnNotification(){var a=Notification.permission;if(a!=="denied"){show_notifications=true}}$(document).ready(function(){AUTOCOMPLETE_TIMEOUT=5000;ds_id=$("#ds_id").html();db_id=$("#db_id").html();ref_id=$("#ref_id").html();symbol=$("#symbol").html();unique_probes_sorted=[];gene_set_name=$("#gene_set_name").html();probe_name=$("#probe_name").html();chip_type=$("#chip_type").html();show_notifications=false;show_axis="no";if(chip_type=="None"||chip_type==""){$("#graphDiv").append("<div class='errorTextColumn'><div id='errorText' class='title errorBox'><div id='message'>Graph Not Found.</div><div id='prompt'> <span id = 'prompt-message'>The Graph is not available for chosen parameters.</span> <br><br> Please Try Following: <br><br> Change Dataset using 'Change Datasets' button provided above <br><br> Change Gene name using the search box provided above <br><br>If you typed the page address in the Address bar, check the spelling and use of upper-case and lower-case letters. </div></div></div>");disable_buttons()}graphType=$("#graphType").html();click_to_select_probes=false;if(graphType==""||graphType==undefined||graphType=="default"){graphType="box"}ref_type=$("#ref_type").html();legend_required="yes";whiskers_needed=true;multiview_graph="no";ref_name={};scaling_required="no";if(ref_type=="ensemblID"){ref_type_for_title="Gene"}else{if(ref_type=="probeID"){ref_type_for_title="Probe"}else{if(ref_type=="miRNA"){ref_type_for_title="miRNA"}else{if(ref_type=="gene_set_id"){ref_type_for_title=gene_set_name;symbol=ref_id}}}}sortBy=$("#sortBy").html();if(sortBy==""||sortBy==undefined||sortBy=="Sample Type"){sortBy="Sample_Type"}var b=document.getElementById("graphDiv");var c=window.location.href;select_probes=$("#select_probe").html();http_variable=c.split("stemformatics")[0];show_min_y_axis=false;normal_graph_box_width=900;graph_box_width=normal_graph_box_width;main_title=return_title(ref_type_for_title,symbol,sortBy);if(select_probes!=""){graph_data_url="/expressions/graph_data?db_id="+db_id+"&ds_id="+ds_id+"&ref_id="+encodeURIComponent(select_probes)+"&ref_type=probeID&graph_type="+graphType}else{graph_data_url="/expressions/graph_data?db_id="+db_id+"&ds_id="+ds_id+"&ref_id="+encodeURIComponent(ref_id)+"&ref_type="+ref_type+"&graph_type="+graphType}dataset_data_url="/expressions/dataset_metadata?ds_id="+ds_id;function a(){return $.ajax({url:dataset_data_url,success:function(e){dataset_metadata=JSON.parse(e);dataset_data=JSON.parse(dataset_metadata.data);dataset_error=dataset_metadata.error;if(dataset_error==""){dataset_data.sampleTypeDisplayGroups=JSON.parse(dataset_data.sampleTypeDisplayGroups);if((dataset_data.lineGraphOrdering)&&(dataset_data.lineGraphOrdering!="NULL")&&(dataset_data.lineGraphOrdering!="")){dataset_data.lineGraphOrdering=JSON.parse(dataset_data.lineGraphOrdering)}if((dataset_data.detectionThreshold)==""||isNaN(dataset_data.detectionThreshold)){dataset_data.detectionThreshold="NULL"}if((dataset_data.medianDatasetExpression)==""||isNaN(dataset_data.medianDatasetExpression)){dataset_data.medianDatasetExpression="NULL"}}}})}function d(){return $.ajax({url:graph_data_url,success:function(e){graph_data=JSON.parse(e);json_data=JSON.parse(graph_data.data);if(json_data!=null){data=json_data}else{data=""}graph_data_error=graph_data.error;if(graph_data_error==""){unique_probes=[];if(ref_type=="gene_set_id"){sorted_data=data.sort(sort_object);for(i=0;i<sorted_data.length;i++){if((unique_probes.indexOf(data[i].Probe)==-1)){unique_probes.push(data[i].Probe)}}unique_probes_sorted=unique_probes}else{for(i=0;i<data.length;i++){if((unique_probes.indexOf(data[i].Probe)==-1)){unique_probes.push(data[i].Probe)}}unique_probes_sorted=unique_probes.sort(sortAlphaNum_array)}limitSortByArray=dataset_data.limitSortBy.split(",");x_axis_label_object={};for(i=0;i<limitSortByArray.length;i++){groupByOption=limitSortByArray[i];groupByOption_with_underscore=groupByOption.replace(" ","_");x_axis_label_object[groupByOption_with_underscore]=[];for(j=0;j<data.length;j++){if((x_axis_label_object[groupByOption_with_underscore].indexOf(data[j][groupByOption_with_underscore])==-1)){x_axis_label_object[groupByOption_with_underscore].push(data[j][groupByOption_with_underscore])}}}}}})}$.when(a(),d()).done(function(){scatter_needed="yes";expanded_graph_box_width=unique_probes_sorted.length*dataset_data.sampleTypeDisplayOrder.split(",").length*40;if(expanded_graph_box_width<graph_box_width){expanded_graph_box_width=graph_box_width}add_limit_sort_by_options_to_dropdown();if(ref_type=="ensemblID"){ref_name[symbol]=symbol}else{if(ref_type=="probeID"){var g=ref_id.split(" ");for(var f=0;f<g.length;f++){for(var e=0;e<data.length;e++){if(data[e]["Probe"]==g[f]){ref_name[data[e]["Probe"]]=data[e]["Mapped_gene"];break}}}}else{if(ref_type=="miRNA"){ref_name[symbol]=symbol}else{if(ref_type="gene_set_id"){for(var f=0;f<unique_probes_sorted.length;f++){for(var e=0;e<data.length;e++){if(data[e]["Probe"]==unique_probes_sorted[f]){ref_name[data[e]["Probe"]]=data[e]["Mapped_gene"];break}}}}}}}$("#showScatter").click(function(){if(scatter_needed=="yes"){scatter_needed="no"}else{scatter_needed="yes"}draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)});draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis);if($("#geneSearchForm").is(":visible")){$("#viewGenes").click(function(){var h=$("#geneSearch").val();graph_data_url=http_variable+"stemformatics.org/expressions/graph_data?db_id="+db_id+"&ds_id="+ds_id+"&ref_id="+h+"&ref_type="+ref_type+"&graph_type="+graphType;$.when(d()).done(function(){$("#graphDiv").empty();$("#graphOptionsMenu .chooseSortType").remove();add_limit_sort_by_options_to_dropdown();draw_graph(graph_data_error,dataset_error,"box",sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)})})}$("a.chooseSortType").click(function(){sortBy=$(this).attr("clickChoose");sortBy=sortBy.replace(" ","_");changeUrl(sortBy,"sortBy");draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)});$("a.chooseGraphType").on("click",function(){graphType=$(this).attr("clickChoose");draw_graph(graph_data_error,dataset_error,graphType,sortBy,show_min_y_axis,ref_name,main_title,whiskers_needed,scaling_required,dataset_data,show_axis)});toggle_SD();toggleYaxis();toggleHorizontal();click_share_link();export_graph_image();export_graph_data();click_gene_info();contextHelpClick();click_select_probes();click_choose_datasets();if($("#choose_dataset_immediately").html()=="True"){$("#chooseDatasets").click()}set_gene_search_and_autocomplete();set_probe_search_and_autocomplete();set_feature_search_and_autocomplete()})});